<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>FlowLab: CFD-–ê–Ω–∞–ª–∏—Ç–∏–∫</title>
<link href="https://fonts.googleapis.com/css2?family=Russo+One&family=Exo+2:wght@300;400;600;700&display=swap" rel="stylesheet">
<style>
:root {
  --bg-dark: #0d1117;
  --bg-card: #161b22;
  --bg-column: #21262d;
  --text-primary: #c9d1d9;
  --text-secondary: #8b949e;
  --accent-green: #238636;
  --accent-blue: #1f6feb;
  --accent-purple: #8957e5;
  --accent-orange: #d29922;
  --accent-red: #da3633;
  --accent-cyan: #39c5cf;
  --todo-color: #8b949e;
  --wip-color: #39c5cf;
  --done-color: #238636;
  --radius: 12px;
}
*{margin:0;padding:0;box-sizing:border-box;}
body{font-family:'Exo 2',sans-serif;background:var(--bg-dark);color:var(--text-primary);min-height:100vh;line-height:1.6;}
::-webkit-scrollbar{width:6px;height:6px;} ::-webkit-scrollbar-track{background:rgba(255,255,255,.05);} ::-webkit-scrollbar-thumb{background:rgba(255,255,255,.2);border-radius:3px;}

/* ====== SCREENS ====== */
.screen{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;z-index:500;background:var(--bg-dark);padding:20px;overflow-y:auto;}
.screen.hidden{display:none!important;}

/* ====== INTRO ====== */
.intro-card{max-width:680px;width:100%;}
.intro-logo{display:flex;align-items:center;gap:12px;margin-bottom:4px;}
.intro-logo .logo-icon{font-size:2em;}
.intro-logo .logo-text{font-family:'Russo One',sans-serif;font-size:clamp(1.8rem,4vw,2.4rem);background:linear-gradient(135deg,var(--accent-green),var(--accent-cyan));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;}
.intro-sub{font-size:.8em;color:var(--text-secondary);margin-bottom:24px;text-transform:uppercase;letter-spacing:2px;}

.intro-brief{background:var(--bg-card);border:1px solid rgba(255,255,255,.1);border-radius:var(--radius);padding:24px;margin-bottom:20px;font-size:.9rem;color:var(--text-secondary);box-shadow:0 8px 24px rgba(0,0,0,.4);}
.intro-brief strong{color:var(--text-primary);}
.intro-brief .hl{color:var(--accent-cyan);font-weight:600;}

.intro-steps{margin:20px 0;display:flex;flex-direction:column;gap:8px;}
.intro-step{display:flex;align-items:center;gap:12px;padding:12px 16px;background:var(--bg-card);border:1px solid rgba(255,255,255,.08);border-radius:8px;font-size:.85rem;transition:.2s;}
.intro-step:hover{border-color:var(--accent-cyan);background:rgba(57,197,207,.05);}
.intro-step .s-num{font-family:'Russo One',sans-serif;font-size:.7rem;color:var(--accent-cyan);background:rgba(57,197,207,.15);padding:4px 10px;border-radius:4px;flex-shrink:0;}
.intro-step .s-label{color:var(--text-primary);font-weight:600;}
.intro-step .s-desc{color:var(--text-secondary);font-size:.78rem;}

/* ====== DATASET SELECTION ====== */
.dataset-section{margin:24px 0;}
.dataset-title{font-family:'Russo One',sans-serif;font-size:1em;color:var(--accent-cyan);margin-bottom:14px;display:flex;align-items:center;gap:8px;}
.dataset-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:10px;}
.dataset-card{background:var(--bg-card);border:2px solid rgba(255,255,255,.08);border-radius:var(--radius);padding:16px;cursor:pointer;transition:.3s;position:relative;}
.dataset-card:hover{border-color:var(--accent-cyan);box-shadow:0 0 20px rgba(57,197,207,.15);transform:translateY(-2px);}
.dataset-card.selected{border-color:var(--accent-cyan);background:rgba(57,197,207,.08);box-shadow:0 0 25px rgba(57,197,207,.2);}
.dataset-card .ds-icon{font-size:1.8em;margin-bottom:8px;}
.dataset-card .ds-name{font-family:'Russo One',sans-serif;font-size:.85em;margin-bottom:4px;}
.dataset-card .ds-desc{font-size:.75em;color:var(--text-secondary);line-height:1.5;}
.dataset-card .ds-badge{position:absolute;top:10px;right:10px;font-size:.6em;padding:3px 8px;border-radius:10px;font-weight:600;text-transform:uppercase;letter-spacing:.5px;}
.badge-stable{background:rgba(35,134,54,.2);color:var(--accent-green);}
.badge-warn{background:rgba(210,153,34,.2);color:var(--accent-orange);}
.badge-danger{background:rgba(218,54,51,.2);color:var(--accent-red);}
.badge-chaos{background:rgba(137,87,229,.2);color:var(--accent-purple);}
.badge-custom{background:rgba(57,197,207,.2);color:var(--accent-cyan);}

/* ====== BUTTONS ====== */
.btn{font-family:'Exo 2',sans-serif;font-weight:600;font-size:.85em;padding:12px 24px;border:none;border-radius:8px;cursor:pointer;transition:.3s;display:inline-flex;align-items:center;gap:8px;}
.btn:disabled{opacity:.35;cursor:not-allowed;}
.btn:hover:not(:disabled){transform:translateY(-2px);}
.btn-primary{background:linear-gradient(135deg,var(--accent-green),var(--accent-cyan));color:#fff;}
.btn-primary:hover:not(:disabled){box-shadow:0 5px 20px rgba(57,197,207,.4);}
.btn-accent{background:linear-gradient(135deg,var(--accent-orange),#ea580c);color:#fff;}
.btn-ghost{background:rgba(255,255,255,.05);color:var(--text-secondary);border:1px solid rgba(255,255,255,.1);}
.btn-ghost:hover:not(:disabled){background:rgba(255,255,255,.1);color:var(--text-primary);}

/* ====== GAME WRAP ====== */
.game-wrap{display:none;flex-direction:column;min-height:100vh;}
.game-wrap.active{display:flex;}

.topbar{display:flex;align-items:center;justify-content:space-between;padding:10px 20px;background:var(--bg-card);border-bottom:1px solid rgba(255,255,255,.1);flex-wrap:wrap;gap:8px;}
.topbar .brand{display:flex;align-items:center;gap:8px;}
.topbar .brand .logo-icon{font-size:1.2em;}
.topbar .brand .logo-text{font-family:'Russo One',sans-serif;font-size:1.1em;background:linear-gradient(135deg,var(--accent-green),var(--accent-cyan));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;}
.phase-badge{font-size:.7em;padding:5px 12px;border-radius:20px;background:rgba(57,197,207,.15);color:var(--accent-cyan);font-weight:600;text-transform:uppercase;letter-spacing:1px;border:1px solid rgba(57,197,207,.25);}

.progress-bar{display:flex;align-items:center;gap:8px;}
.progress-dots{display:flex;gap:4px;}
.p-dot{width:10px;height:10px;border-radius:50%;background:var(--bg-column);border:1.5px solid rgba(255,255,255,.15);transition:.3s;}
.p-dot.done{background:var(--accent-green);border-color:var(--accent-green);}
.p-dot.current{background:var(--accent-cyan);border-color:var(--accent-cyan);box-shadow:0 0 8px rgba(57,197,207,.5);}
.score-display{font-size:.8em;color:var(--accent-cyan);font-weight:700;}

/* ====== MAIN AREA ====== */
.main-area{flex:1;display:flex;flex-direction:column;align-items:center;padding:20px;overflow-y:auto;}
.content-card{max-width:900px;width:100%;background:var(--bg-card);border:1px solid rgba(255,255,255,.08);border-radius:var(--radius);box-shadow:0 8px 32px rgba(0,0,0,.4);overflow:hidden;animation:fadeUp .35s ease;margin-bottom:20px;}
@keyframes fadeUp{from{opacity:0;transform:translateY(12px)}to{opacity:1;transform:translateY(0)}}

.cc-header{padding:20px 24px 0;display:flex;align-items:flex-start;gap:12px;}
.cc-type{font-size:.65em;text-transform:uppercase;letter-spacing:2px;padding:5px 12px;border-radius:20px;font-weight:600;flex-shrink:0;}
.type-input{background:rgba(57,197,207,.15);color:var(--accent-cyan);border:1px solid rgba(57,197,207,.25);}
.type-theory{background:rgba(31,111,235,.15);color:var(--accent-blue);border:1px solid rgba(31,111,235,.25);}
.type-quiz{background:rgba(137,87,229,.15);color:var(--accent-purple);border:1px solid rgba(137,87,229,.25);}
.type-report{background:rgba(35,134,54,.15);color:var(--accent-green);border:1px solid rgba(35,134,54,.25);}

.cc-body{padding:16px 24px 24px;}
.cc-title{font-family:'Russo One',sans-serif;font-size:1.2em;margin-bottom:4px;line-height:1.3;}
.cc-desc{font-size:.85rem;color:var(--text-secondary);margin-bottom:16px;line-height:1.6;}

/* ====== DATA TABLE ====== */
.data-table-wrap{overflow-x:auto;margin-bottom:16px;border:1px solid rgba(255,255,255,.08);border-radius:8px;}
.data-table{width:100%;border-collapse:collapse;font-size:.8rem;}
.data-table th{font-family:'Russo One',sans-serif;font-size:.65rem;text-transform:uppercase;letter-spacing:1px;padding:8px 6px;background:var(--bg-column);color:var(--text-secondary);border-bottom:1px solid rgba(255,255,255,.08);text-align:center;position:sticky;top:0;}
.data-table th:first-child{text-align:left;padding-left:12px;}
.data-table td{padding:4px 4px;border-bottom:1px solid rgba(255,255,255,.04);text-align:center;vertical-align:middle;}
.data-table td:first-child{font-weight:600;font-size:.75rem;color:var(--accent-cyan);padding-left:12px;text-align:left;white-space:nowrap;}
.data-table tr:hover{background:rgba(57,197,207,.04);}
.data-table input{width:52px;padding:5px 4px;border:1px solid rgba(255,255,255,.12);border-radius:4px;text-align:center;font-family:'Exo 2',sans-serif;font-size:.8rem;background:var(--bg-dark);color:var(--text-primary);transition:.2s;}
.data-table input:focus{outline:none;border-color:var(--accent-cyan);box-shadow:0 0 0 2px rgba(57,197,207,.2);}
.data-table input.err{border-color:var(--accent-red);background:rgba(218,54,51,.1);}
.data-table .calc-cell{font-weight:600;font-size:.78rem;}
.data-table .calc-wip{color:var(--wip-color);}
.data-table .calc-th{color:var(--done-color);}

/* ====== CHART ====== */
.chart-container{background:var(--bg-column);border:1px solid rgba(255,255,255,.08);border-radius:8px;padding:12px;margin-bottom:16px;position:relative;}
.chart-container canvas{display:block;width:100%;border-radius:4px;}
.chart-legend{display:flex;gap:14px;justify-content:center;margin-top:8px;font-size:.72rem;color:var(--text-secondary);}
.chart-legend .leg{display:flex;align-items:center;gap:5px;}
.leg-dot{width:10px;height:10px;border-radius:3px;flex-shrink:0;}

/* ====== THEORY ====== */
.theory-card{padding:16px 20px;background:rgba(31,111,235,.1);border:1px solid rgba(31,111,235,.2);border-radius:8px;font-size:.84rem;color:var(--text-primary);line-height:1.65;margin-bottom:14px;}
.theory-card strong{color:var(--accent-cyan);font-weight:700;}
.theory-card .th-title{font-family:'Russo One',sans-serif;font-size:.7rem;text-transform:uppercase;letter-spacing:1.5px;margin-bottom:6px;color:var(--accent-blue);}

/* ====== QUIZ ====== */
.options-list{display:flex;flex-direction:column;gap:8px;margin-bottom:14px;}
.opt-btn{display:flex;align-items:flex-start;gap:12px;padding:14px 16px;background:var(--bg-column);border:2px solid rgba(255,255,255,.08);border-radius:8px;cursor:pointer;transition:.2s;text-align:left;color:var(--text-primary);font-family:'Exo 2',sans-serif;font-size:.86rem;line-height:1.55;}
.opt-btn:hover{border-color:var(--accent-cyan);background:rgba(57,197,207,.06);}
.opt-letter{font-family:'Russo One',sans-serif;font-size:.75rem;color:var(--accent-cyan);background:rgba(57,197,207,.15);width:26px;height:26px;display:flex;align-items:center;justify-content:center;border-radius:6px;flex-shrink:0;}
.opt-btn.c-best{border-color:var(--accent-green)!important;background:rgba(35,134,54,.12)!important;}
.opt-btn.c-ok{border-color:var(--accent-orange)!important;background:rgba(210,153,34,.1)!important;}
.opt-btn.c-bad{border-color:var(--accent-red)!important;background:rgba(218,54,51,.1)!important;}
.opt-btn.c-dim{opacity:.3;}

.fb-box{padding:16px;border-radius:8px;font-size:.84rem;line-height:1.65;margin-bottom:12px;display:none;}
.fb-box.show{display:block;}
.fb-box.fb-great{background:rgba(35,134,54,.12);border:1px solid rgba(35,134,54,.3);color:var(--accent-green);}
.fb-box.fb-ok{background:rgba(210,153,34,.1);border:1px solid rgba(210,153,34,.25);color:var(--accent-orange);}
.fb-box.fb-bad{background:rgba(218,54,51,.1);border:1px solid rgba(218,54,51,.25);color:var(--accent-red);}
.fb-title{font-weight:700;margin-bottom:4px;}

/* ====== METRICS GRID ====== */
.metrics-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:10px;margin-bottom:16px;}
.metric-card{padding:14px;background:var(--bg-column);border:1px solid rgba(255,255,255,.06);border-radius:8px;text-align:center;transition:.2s;}
.metric-card:hover{border-color:rgba(57,197,207,.2);}
.metric-val{font-family:'Russo One',sans-serif;font-size:1.6rem;line-height:1.2;}
.metric-val.v-cyan{color:var(--accent-cyan);}
.metric-val.v-blue{color:var(--accent-blue);}
.metric-val.v-green{color:var(--accent-green);}
.metric-val.v-warn{color:var(--accent-red);}
.metric-val.v-purple{color:var(--accent-purple);}
.metric-val.v-orange{color:var(--accent-orange);}
.metric-label{font-size:.7rem;color:var(--text-secondary);text-transform:uppercase;letter-spacing:.5px;margin-top:2px;}

/* ====== REPORT ====== */
.report-section{margin-bottom:12px;padding:16px;border-radius:8px;}
.report-section.r-good{background:rgba(35,134,54,.1);border:1px solid rgba(35,134,54,.25);}
.report-section.r-warn{background:rgba(210,153,34,.08);border:1px solid rgba(210,153,34,.2);}
.report-section.r-bad{background:rgba(218,54,51,.08);border:1px solid rgba(218,54,51,.2);}
.report-section.r-info{background:rgba(31,111,235,.08);border:1px solid rgba(31,111,235,.2);}
.r-title{font-family:'Russo One',sans-serif;font-size:.75rem;text-transform:uppercase;letter-spacing:1.5px;margin-bottom:6px;}
.r-good .r-title{color:var(--accent-green);}
.r-warn .r-title{color:var(--accent-orange);}
.r-bad .r-title{color:var(--accent-red);}
.r-info .r-title{color:var(--accent-blue);}
.r-text{font-size:.86rem;line-height:1.65;color:var(--text-secondary);}
.r-text strong{color:var(--text-primary);}

.pattern-tag{display:inline-block;font-size:.7em;padding:4px 10px;border-radius:20px;margin:2px 2px;font-weight:600;letter-spacing:.3px;}
.pt-good{background:rgba(35,134,54,.15);color:var(--accent-green);border:1px solid rgba(35,134,54,.25);}
.pt-warn{background:rgba(210,153,34,.12);color:var(--accent-orange);border:1px solid rgba(210,153,34,.2);}
.pt-bad{background:rgba(218,54,51,.12);color:var(--accent-red);border:1px solid rgba(218,54,51,.2);}

/* ====== FORECAST ====== */
.forecast-box{background:var(--bg-column);border:1px solid rgba(255,255,255,.06);border-radius:8px;padding:16px;margin-bottom:12px;}
.forecast-row{display:flex;justify-content:space-between;padding:6px 0;border-bottom:1px solid rgba(255,255,255,.04);font-size:.84rem;}
.forecast-row:last-child{border-bottom:none;}
.forecast-row .f-label{color:var(--text-secondary);}
.forecast-row .f-val{font-weight:700;color:var(--accent-cyan);}

/* ====== FINISH ====== */
.finish-card{max-width:560px;width:100%;background:var(--bg-card);border:1px solid rgba(255,255,255,.08);border-radius:var(--radius);padding:32px;box-shadow:0 8px 32px rgba(0,0,0,.5);text-align:center;}
.finish-card .f-title{font-family:'Russo One',sans-serif;font-size:1.8rem;margin-bottom:6px;background:linear-gradient(135deg,var(--accent-green),var(--accent-cyan));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;}
.finish-card .f-score{font-family:'Russo One',sans-serif;font-size:2.5rem;color:var(--accent-cyan);margin:8px 0;}
.finish-card .f-rank{font-size:.9rem;color:var(--accent-green);margin-bottom:20px;}
.f-stats{text-align:left;margin:16px 0;}
.f-stat{display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid rgba(255,255,255,.06);font-size:.85rem;color:var(--text-secondary);}
.f-stat .fv{color:var(--accent-cyan);font-weight:700;}
.f-grade{margin:16px 0;padding:14px;border-radius:8px;font-size:.88rem;line-height:1.6;text-align:left;}
.f-grade.g-s{background:rgba(35,134,54,.12);border:1px solid rgba(35,134,54,.25);color:var(--accent-green);}
.f-grade.g-a{background:rgba(31,111,235,.1);border:1px solid rgba(31,111,235,.2);color:var(--accent-blue);}
.f-grade.g-b{background:rgba(210,153,34,.1);border:1px solid rgba(210,153,34,.2);color:var(--accent-orange);}
.f-grade.g-c{background:rgba(218,54,51,.1);border:1px solid rgba(218,54,51,.2);color:var(--accent-red);}

.btn-row{display:flex;gap:10px;margin-top:14px;flex-wrap:wrap;}
.btn-row .btn{flex:1;min-width:120px;justify-content:center;}

.tip-box{font-size:.8rem;color:var(--text-secondary);padding:12px 14px;background:var(--bg-column);border:1px solid rgba(255,255,255,.06);border-radius:8px;margin-bottom:12px;}
.tip-box strong{color:var(--accent-cyan);}

@media (max-width:768px){
  .dataset-grid{grid-template-columns:1fr 1fr;}
  .metrics-grid{grid-template-columns:repeat(2,1fr);}
}
@media (max-width:480px){
  .dataset-grid{grid-template-columns:1fr;}
}
</style>
</head>
<body>

<div class="screen" id="introScreen">
<div class="intro-card">
  <div class="intro-logo">
    <span class="logo-icon">üìä</span>
    <span class="logo-text">FlowLab</span>
  </div>
  <div class="intro-sub">CFD-–ê–Ω–∞–ª–∏—Ç–∏–∫ –≤–∞—à–∏—Ö –¥–∞–Ω–Ω—ã—Ö</div>

  <div class="intro-brief">
    –í—ã –ø—Ä–æ—à–ª–∏ <strong>Lean Flow Simulation</strong> –∏ –ø–æ–ª—É—á–∏–ª–∏ –¥–∏–∞–≥—Ä–∞–º–º—É –ø–æ—Ç–æ–∫–∞ –∑–∞ 21 –¥–µ–Ω—å. –¢–µ–ø–µ—Ä—å –ø—Ä–∏—à–ª–æ –≤—Ä–µ–º—è <span class="hl">–ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã</span> –∫–∞–∫ –Ω–∞—Å—Ç–æ—è—â–∏–π Kanban-–∫–æ—É—á.<br><br>
    –í–≤–µ–¥–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ –∏–∑ –≤–∞—à–µ–π CFD, –∏–∑—É—á–∏—Ç–µ —Ç–µ–æ—Ä–∏—é –∞–Ω–∞–ª–∏–∑–∞, –æ—Ç–≤–µ—Ç—å—Ç–µ –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã –æ <strong>–≤–∞—à–µ–π –¥–∏–∞–≥—Ä–∞–º–º–µ</strong>, –∏ –ø–æ–ª—É—á–∏—Ç–µ <span class="hl">–∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∏–π –æ—Ç—á—ë—Ç —Å –ø—Ä–æ–≥–Ω–æ–∑–æ–º</span>.
  </div>

  <div class="intro-steps">
    <div class="intro-step"><span class="s-num">01</span><div><div class="s-label">–í–≤–æ–¥ –¥–∞–Ω–Ω—ã—Ö</div><div class="s-desc">–í–≤–µ–¥–∏—Ç–µ ToDo, In Progress, Done –∑–∞ –∫–∞–∂–¥—ã–π –∏–∑ 21 –¥–Ω—è</div></div></div>
    <div class="intro-step"><span class="s-num">02</span><div><div class="s-label">–¢–µ–æ—Ä–∏—è + –∞–Ω–∞–ª–∏–∑</div><div class="s-desc">–ò–∑—É—á–∏—Ç–µ –∫–∞–∫ —á–∏—Ç–∞—Ç—å –º–µ—Ç—Ä–∏–∫–∏ –Ω–∞ CFD –∏ –æ—Ç–≤–µ—Ç—å—Ç–µ –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã</div></div></div>
    <div class="intro-step"><span class="s-num">03</span><div><div class="s-label">–ü–∞—Ç—Ç–µ—Ä–Ω—ã</div><div class="s-desc">–û–ø—Ä–µ–¥–µ–ª–∏—Ç–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã –Ω–∞ –≤–∞—à–µ–π –¥–∏–∞–≥—Ä–∞–º–º–µ</div></div></div>
    <div class="intro-step"><span class="s-num">04</span><div><div class="s-label">–û—Ç—á—ë—Ç –∏ –ø—Ä–æ–≥–Ω–æ–∑</div><div class="s-desc">–ü–æ–ª—É—á–∏—Ç–µ –∞–Ω–∞–ª–∏—Ç–∏–∫—É, –ø—Ä–æ–≥–Ω–æ–∑ –∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏</div></div></div>
  </div>

  <div class="dataset-section">
    <div class="dataset-title">üìã –í—ã–±–µ—Ä–∏—Ç–µ –Ω–∞–±–æ—Ä –¥–∞–Ω–Ω—ã—Ö –∏–ª–∏ –≤–≤–µ–¥–∏—Ç–µ —Å–≤–æ–∏</div>
    <div class="dataset-grid" id="datasetGrid"></div>
  </div>

  <button class="btn btn-primary" id="btnStart" onclick="startGame()" style="width:100%;padding:14px;justify-content:center;">‚ñ∂ –ù–∞—á–∞—Ç—å –∞–Ω–∞–ª–∏–∑</button>
</div>
</div>

<div class="screen hidden" id="finishScreen">
<div class="finish-card">
  <div class="f-title" id="fTitle"></div>
  <div class="f-score" id="fScore"></div>
  <div class="f-rank" id="fRank"></div>
  <div class="f-stats" id="fStats"></div>
  <div class="f-grade" id="fGrade"></div>
  <button class="btn btn-primary" onclick="location.reload()" style="width:100%;margin-top:12px;justify-content:center;">‚Üª –ü—Ä–æ–π—Ç–∏ –∑–∞–Ω–æ–≤–æ</button>
</div>
</div>

<div class="game-wrap" id="gameWrap">
  <div class="topbar">
    <div class="brand"><span class="logo-icon">üìä</span><span class="logo-text">FlowLab</span></div>
    <div class="phase-badge" id="phaseBadge">–í–≤–æ–¥ –¥–∞–Ω–Ω—ã—Ö</div>
    <div class="progress-bar">
      <div class="progress-dots" id="progDots"></div>
      <div class="score-display" id="scoreDisp">0 pts</div>
    </div>
  </div>
  <div class="main-area" id="mainArea"></div>
</div>

<script>
// ============================================================
// PRESET DATASETS
// ============================================================
var DATASETS = [
  {
    id: 'custom',
    name: '–°–≤–æ–∏ –¥–∞–Ω–Ω—ã–µ',
    icon: '‚úèÔ∏è',
    badge: 'custom',
    badgeText: '–í–≤–æ–¥',
    desc: '–í–≤–µ–¥–∏—Ç–µ —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∏–∑ –≤–∞—à–µ–π Lean Flow Simulation',
    data: null
  },
  {
    id: 'stable',
    name: '–°—Ç–∞–±–∏–ª—å–Ω—ã–π –ø–æ—Ç–æ–∫',
    icon: 'üü¢',
    badge: 'stable',
    badgeText: '–°—Ç–∞–±–∏–ª—å–Ω—ã–π',
    desc: '–ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã–µ –ª–∏–Ω–∏–∏, WIP —Å—Ç–∞–±–∏–ª–µ–Ω, Throughput –ø—Ä–µ–¥—Å–∫–∞–∑—É–µ–º. –ó—Ä–µ–ª–∞—è –∫–æ–º–∞–Ω–¥–∞.',
    data: {
      todo:[20,19,18,17,16,15,14,13,12,11,10,9,8,7,6,5,4,3,2,1,0],
      wip: [0, 1, 2, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3],
      done:[0, 0, 0, 0, 1, 2, 3, 4, 5, 6, 7, 8, 9,10,11,12,13,14,15,16,17]
    }
  },
  {
    id: 'divergent',
    name: '–†–∞—Å—Ö–æ–∂–¥–µ–Ω–∏–µ –ª–∏–Ω–∏–π',
    icon: 'üî¥',
    badge: 'danger',
    badgeText: '–û–ø–∞—Å–Ω—ã–π',
    desc: 'WIP –ø–æ—Å—Ç–æ—è–Ω–Ω–æ —Ä–∞—Å—Ç—ë—Ç, Arrival Rate > Throughput. –°–∏—Å—Ç–µ–º–∞ –ø–µ—Ä–µ–≥—Ä—É–∂–µ–Ω–∞.',
    data: {
      todo:[15,16,17,17,18,18,19,19,20,20,21,22,22,23,23,24,24,25,25,26,26],
      wip: [0, 2, 3, 5, 6, 8, 9,10,11,13,14,14,15,16,17,17,18,18,19,19,20],
      done:[0, 0, 0, 1, 1, 2, 2, 3, 3, 4, 4, 5, 5, 6, 6, 7, 7, 8, 8, 9, 9]
    }
  },
  {
    id: 'staircase',
    name: '–õ–µ—Å—Ç–Ω–∏—Ü–∞ (Scrum)',
    icon: 'üü°',
    badge: 'warn',
    badgeText: '–ò—Ç–µ—Ä–∞—Ç–∏–≤–Ω—ã–π',
    desc: '–ó–∞–¥–∞—á–∏ –∑–∞–≤–µ—Ä—à–∞—é—Ç—Å—è –ø–∞—á–∫–∞–º–∏ –≤ –∫–æ–Ω—Ü–µ —Å–ø—Ä–∏–Ω—Ç–æ–≤. –¢–∏–ø–∏—á–Ω—ã–π Scrum-–ø–∞—Ç—Ç–µ—Ä–Ω.',
    data: {
      todo:[20,19,18,17,16,15,14,13,13,13,12,11,10,9,8,7,7,7,7,6,5],
      wip: [0, 1, 2, 3, 4, 5, 5, 5, 2, 1, 1, 2, 3, 4, 5, 5, 4, 2, 1, 1, 1],
      done:[0, 0, 0, 0, 0, 0, 1, 2, 5, 6, 7, 7, 7, 7, 7, 8, 9,11,12,13,14]
    }
  },
  {
    id: 'bottleneck',
    name: '–ë—É—Ç—ã–ª–æ—á–Ω–æ–µ –≥–æ—Ä–ª—ã—à–∫–æ',
    icon: 'üü†',
    badge: 'warn',
    badgeText: '–ë–ª–æ–∫–µ—Ä',
    desc: '–°—Ç–∞–≥–Ω–∞—Ü–∏—è Done –≤ —Å–µ—Ä–µ–¥–∏–Ω–µ –ø–µ—Ä–∏–æ–¥–∞. –ë–ª–æ–∫–µ—Ä –Ω–∞ —ç—Ç–∞–ø–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è, –∑–∞—Ç–µ–º –ø—Ä–æ—Ä—ã–≤.',
    data: {
      todo:[18,17,16,15,14,13,12,11,10,10,10,10,10,9,8,7,6,5,4,3,2],
      wip: [0, 1, 2, 3, 4, 5, 6, 7, 8, 8, 8, 8, 8, 7, 6, 5, 5, 4, 3, 3, 2],
      done:[0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2, 4, 6, 7, 9,11,12,14]
    }
  },
  {
    id: 'flood',
    name: '–†–∞–∑–ª–∏–≤ WIP',
    icon: 'üåä',
    badge: 'danger',
    badgeText: '–ü–µ—Ä–µ–≥—Ä—É–∑–∫–∞',
    desc: 'WIP —Ä–µ–∑–∫–æ –≤–æ–∑—Ä–∞—Å—Ç–∞–µ—Ç –≤ —Å–µ—Ä–µ–¥–∏–Ω–µ, –∑–∞—Ç–µ–º —á–∞—Å—Ç–∏—á–Ω–æ –Ω–æ—Ä–º–∞–ª–∏–∑—É–µ—Ç—Å—è. –ü–∏–∫ –Ω–∞–≥—Ä—É–∑–∫–∏.',
    data: {
      todo:[20,18,16,14,12,10,8,6,6,6,7,8,8,8,7,6,5,4,3,2,1],
      wip: [0, 2, 4, 6, 8,10,12,14,13,12,10,8, 7, 6, 6, 5, 5, 4, 4, 3, 3],
      done:[0, 0, 0, 0, 0, 0, 0, 0, 1, 2, 3, 4, 5, 6, 7, 9,10,12,13,15,16]
    }
  },
  {
    id: 'improving',
    name: '–†–∞—Å—Ç—É—â–∏–π Throughput',
    icon: 'üìà',
    badge: 'stable',
    badgeText: '–£–ª—É—á—à–µ–Ω–∏–µ',
    desc: '–ö–æ–º–∞–Ω–¥–∞ –Ω–∞–±–∏—Ä–∞–µ—Ç —Å–∫–æ—Ä–æ—Å—Ç—å: Throughput —Ä–∞—Å—Ç—ë—Ç –æ—Ç –Ω–∞—á–∞–ª–∞ –∫ –∫–æ–Ω—Ü—É. –ö—Ä–∏–≤–∞—è –æ–±—É—á–µ–Ω–∏—è.',
    data: {
      todo:[25,24,23,22,21,20,19,18,17,16,14,12,10,8, 6, 4, 3, 2, 1, 0, 0],
      wip: [0, 1, 2, 3, 3, 3, 3, 3, 3, 3, 4, 4, 4, 4, 4, 4, 3, 3, 2, 2, 1],
      done:[0, 0, 0, 0, 1, 2, 3, 4, 5, 6, 7, 9,11,13,15,17,19,20,22,23,24]
    }
  }
];

// ============================================================
// STATE
// ============================================================
var DAYS = 21;
var G = {
  step: 0,
  score: 0,
  best: 0,
  ok: 0,
  bad: 0,
  answered: false,
  data: null,
  metrics: null,
  selectedDataset: 'custom'
};

var TOTAL_STEPS = 12;

// ============================================================
// DATASET SELECTION UI
// ============================================================
function renderDatasetCards() {
  var grid = document.getElementById('datasetGrid');
  grid.innerHTML = DATASETS.map(function(ds) {
    var badgeCls = ds.badge === 'stable' ? 'badge-stable' : ds.badge === 'warn' ? 'badge-warn' : ds.badge === 'danger' ? 'badge-danger' : ds.badge === 'chaos' ? 'badge-chaos' : 'badge-custom';
    var sel = G.selectedDataset === ds.id ? ' selected' : '';
    return '<div class="dataset-card' + sel + '" onclick="selectDataset(\'' + ds.id + '\')">'
      + '<span class="ds-badge ' + badgeCls + '">' + ds.badgeText + '</span>'
      + '<div class="ds-icon">' + ds.icon + '</div>'
      + '<div class="ds-name">' + ds.name + '</div>'
      + '<div class="ds-desc">' + ds.desc + '</div>'
      + '</div>';
  }).join('');
}

function selectDataset(id) {
  G.selectedDataset = id;
  renderDatasetCards();
}

// ============================================================
// CFD RENDERER
// ============================================================
function renderCFD(canvas, data, opts) {
  opts = opts || {};
  var dpr = window.devicePixelRatio || 1;
  var w = canvas.parentElement.clientWidth - 24;
  var h = opts.height || 260;
  canvas.width = w * dpr; canvas.height = h * dpr;
  canvas.style.width = w+'px'; canvas.style.height = h+'px';
  var ctx = canvas.getContext('2d');
  ctx.scale(dpr, dpr);

  var pad = { top:24, right:20, bottom:32, left:48 };
  var cw = w - pad.left - pad.right;
  var ch = h - pad.top - pad.bottom;
  var n = data.done.length;
  if (n < 2) return;

  var cumDone = data.done.slice();
  var cumWip = data.done.map(function(v,i){return v + data.wip[i];});
  var cumTodo = data.done.map(function(v,i){return v + data.wip[i] + data.todo[i];});
  var maxVal = Math.max.apply(null, cumTodo) * 1.1 || 10;

  function xp(i) { return pad.left + (i/(n-1))*cw; }
  function yp(v) { return pad.top + ch - (v/maxVal)*ch; }

  // grid
  ctx.strokeStyle = 'rgba(255,255,255,.06)'; ctx.lineWidth = .5;
  for (var gi=0;gi<=5;gi++) {
    var gy = pad.top + (gi/5)*ch;
    ctx.beginPath(); ctx.moveTo(pad.left, gy); ctx.lineTo(w-pad.right, gy); ctx.stroke();
  }

  var stacks = [cumDone, cumWip, cumTodo];
  var fills = ['rgba(35,134,54,.4)','rgba(57,197,207,.35)','rgba(139,148,158,.25)'];
  var strokes = ['#238636','#39c5cf','#8b949e'];

  for (var s=2;s>=0;s--) {
    ctx.fillStyle = fills[s];
    ctx.beginPath();
    ctx.moveTo(xp(0), yp(stacks[s][0]));
    for(var i=1;i<n;i++) ctx.lineTo(xp(i), yp(stacks[s][i]));
    if(s===0) { ctx.lineTo(xp(n-1), yp(0)); ctx.lineTo(xp(0), yp(0)); }
    else { for(var i2=n-1;i2>=0;i2--) ctx.lineTo(xp(i2), yp(stacks[s-1][i2])); }
    ctx.closePath(); ctx.fill();
    ctx.strokeStyle = strokes[s]; ctx.lineWidth = 2;
    ctx.beginPath(); ctx.moveTo(xp(0), yp(stacks[s][0]));
    for(var i3=1;i3<n;i3++) ctx.lineTo(xp(i3), yp(stacks[s][i3]));
    ctx.stroke();
  }

  // annotations
  if (opts.annotations) {
    opts.annotations.forEach(function(a) {
      ctx.save();
      if (a.type === 'vline') {
        var xi = xp(a.idx);
        ctx.setLineDash([5,4]); ctx.strokeStyle = a.color||'var(--accent-orange)'; ctx.lineWidth = 1.5;
        ctx.beginPath(); ctx.moveTo(xi, pad.top); ctx.lineTo(xi, h-pad.bottom); ctx.stroke();
        if(a.label){ctx.fillStyle=a.color||'#d29922';ctx.font='600 10px Exo 2';ctx.fillText(a.label, xi+3, pad.top+12);}
      }
      if (a.type === 'hline') {
        ctx.setLineDash([5,4]); ctx.strokeStyle = a.color||'#d29922'; ctx.lineWidth = 1.5;
        ctx.beginPath(); ctx.moveTo(pad.left, yp(a.val)); ctx.lineTo(w-pad.right, yp(a.val)); ctx.stroke();
        if(a.label){ctx.fillStyle=a.color||'#d29922';ctx.font='600 10px Exo 2';ctx.fillText(a.label, w-pad.right-ctx.measureText(a.label).width-4, yp(a.val)-4);}
      }
      if (a.type === 'zone') {
        ctx.fillStyle = a.color || 'rgba(57,197,207,.06)';
        ctx.fillRect(xp(a.from), pad.top, xp(a.to)-xp(a.from), ch);
      }
      ctx.restore();
    });
  }

  // axis labels
  ctx.fillStyle = '#8b949e'; ctx.font = '10px Exo 2';
  for(var d=0;d<n;d++){
    if(d % Math.max(1,Math.floor(n/7)) === 0 || d===n-1){
      ctx.fillText('–î'+(d+1), xp(d)-8, h-pad.bottom+14);
    }
  }
  for(var v2=0;v2<=5;v2++){
    var val = Math.round((maxVal/5)*v2);
    ctx.fillText(val, 2, yp(val)+3);
  }
  ctx.fillStyle='#8b949e'; ctx.font='600 9px Exo 2';
  ctx.fillText('–ó–∞–¥–∞—á–∏', 0, pad.top-8);
}

// ============================================================
// METRICS CALCULATION
// ============================================================
function calcMetrics(data) {
  var n = data.done.length;
  var wips = data.wip.slice();
  var avgWip = wips.reduce(function(a,b){return a+b;},0) / n;

  var tputs = [];
  for(var i=1;i<n;i++) tputs.push(Math.max(0, data.done[i] - data.done[i-1]));
  var avgTh = tputs.length > 0 ? tputs.reduce(function(a,b){return a+b;},0) / tputs.length : 0;
  var totalDone = data.done[n-1] - data.done[0];

  var avgLT = avgTh > 0 ? avgWip / avgTh : 0;

  var half = Math.floor(n/2);
  var wipFirst = wips.slice(0, half).reduce(function(a,b){return a+b;},0) / half;
  var wipSecond = wips.slice(half).reduce(function(a,b){return a+b;},0) / (n-half);
  var wipTrend = wipSecond - wipFirst;

  var thFirst = tputs.slice(0, Math.floor(tputs.length/2));
  var thSecond = tputs.slice(Math.floor(tputs.length/2));
  var thFirstAvg = thFirst.length > 0 ? thFirst.reduce(function(a,b){return a+b;},0)/thFirst.length : 0;
  var thSecondAvg = thSecond.length > 0 ? thSecond.reduce(function(a,b){return a+b;},0)/thSecond.length : 0;
  var thTrend = thSecondAvg - thFirstAvg;

  var maxWip = Math.max.apply(null, wips);
  var minWip = Math.min.apply(null, wips);

  var arrivals = [];
  for(var j=1;j<n;j++){
    var totalJ = data.todo[j]+data.wip[j]+data.done[j];
    var totalPrev = data.todo[j-1]+data.wip[j-1]+data.done[j-1];
    arrivals.push(Math.max(0, totalJ - totalPrev));
  }
  var avgArrival = arrivals.length > 0 ? arrivals.reduce(function(a,b){return a+b;},0)/arrivals.length : 0;

  var flowEff = avgTh > 0 && avgWip > 0 ? Math.min(100, (avgTh / avgWip) * 100) : 0;

  var remainingTodo = data.todo[n-1];
  var remainingWip = data.wip[n-1];
  var remaining = remainingTodo + remainingWip;

  var forecastDays = avgTh > 0 ? Math.ceil(remaining / avgTh) : Infinity;

  var stallDays = 0;
  var maxStall = 0;
  for(var k=1;k<n;k++){
    if(data.done[k] <= data.done[k-1]) { stallDays++; if(stallDays > maxStall) maxStall = stallDays; }
    else stallDays = 0;
  }

  var isDiverging = wipTrend > 2;

  var thMean = avgTh;
  var thVar = tputs.reduce(function(a,b){return a + (b-thMean)*(b-thMean);},0) / Math.max(1,tputs.length);
  var thStd = Math.sqrt(thVar);
  var thCV = thMean > 0 ? thStd / thMean : 0;

  return {
    avgWip: Math.round(avgWip*10)/10,
    avgTh: Math.round(avgTh*10)/10,
    avgLT: Math.round(avgLT*10)/10,
    totalDone: totalDone,
    maxWip: maxWip,
    minWip: minWip,
    wipTrend: Math.round(wipTrend*10)/10,
    thTrend: Math.round(thTrend*10)/10,
    avgArrival: Math.round(avgArrival*10)/10,
    flowEff: Math.round(flowEff),
    remaining: remaining,
    forecastDays: forecastDays,
    maxStall: maxStall,
    isDiverging: isDiverging,
    thCV: Math.round(thCV*100)/100,
    tputs: tputs,
    wips: wips
  };
}

// ============================================================
// PATTERN DETECTION
// ============================================================
function detectPatterns(data, m) {
  var patterns = [];

  if (m.isDiverging) {
    patterns.push({name:'–†–∞—Å—Ö–æ–∂–¥–µ–Ω–∏–µ –ª–∏–Ω–∏–π', severity:'bad', desc:'WIP —Ä–∞—Å—Ç—ë—Ç –æ—Ç –Ω–∞—á–∞–ª–∞ –∫ –∫–æ–Ω—Ü—É. Arrival Rate > Throughput. –°–∏—Å—Ç–µ–º–∞ –Ω–µ—Å—Ç–∞–±–∏–ª—å–Ω–∞.'});
  }
  if (m.maxStall >= 3) {
    patterns.push({name:'–°—Ç–∞–≥–Ω–∞—Ü–∏—è Done ('+m.maxStall+' –¥–Ω.)', severity:'bad', desc:'Departure Line –Ω–µ —Ä–æ—Å–ª–∞ '+m.maxStall+' –¥–Ω–µ–π –ø–æ–¥—Ä—è–¥. –í–æ–∑–º–æ–∂–µ–Ω –±–ª–æ–∫–µ—Ä –Ω–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏.'});
  }
  if (m.maxWip > m.avgWip * 1.8) {
    patterns.push({name:'–†–∞–∑–ª–∏–≤ WIP (–ø–∏–∫: '+m.maxWip+')', severity:'warn', desc:'–ü–∏–∫–æ–≤—ã–π WIP –∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω–æ –≤—ã—à–µ —Å—Ä–µ–¥–Ω–µ–≥–æ. –ë—ã–ª–∏ –ø–µ—Ä–∏–æ–¥—ã –ø–µ—Ä–µ–≥—Ä—É–∑–∫–∏.'});
  }
  if (m.avgWip > 15) {
    patterns.push({name:'–í—ã—Å–æ–∫–∏–π —Å—Ä–µ–¥–Ω–∏–π WIP', severity:'warn', desc:'–°—Ä–µ–¥–Ω–∏–π WIP = '+m.avgWip+'. –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–π –¥–ª—è –Ω–µ–±–æ–ª—å—à–æ–π –∫–æ–º–∞–Ω–¥—ã: 3-8.'});
  }
  if (Math.abs(m.wipTrend) < 1.5 && m.avgWip < 12 && m.thCV < 0.8) {
    patterns.push({name:'–°—Ç–∞–±–∏–ª—å–Ω—ã–π –ø–æ—Ç–æ–∫', severity:'good', desc:'WIP —Å—Ç–∞–±–∏–ª–µ–Ω, Throughput –ø—Ä–µ–¥—Å–∫–∞–∑—É–µ–º. –•–æ—Ä–æ—à–∏–π –∑–Ω–∞–∫!'});
  }
  if (m.thCV > 1.0) {
    patterns.push({name:'–í—ã—Å–æ–∫–∞—è –≤–∞—Ä–∏–∞–±–µ–ª—å–Ω–æ—Å—Ç—å', severity:'warn', desc:'Coefficient of Variation Throughput = '+m.thCV+'. –ü—Ä–µ–¥—Å–∫–∞–∑—É–µ–º–æ—Å—Ç—å –Ω–∏–∑–∫–∞—è.'});
  }
  if (m.thTrend > 0.5) {
    patterns.push({name:'–†–∞—Å—Ç—É—â–∏–π Throughput', severity:'good', desc:'Throughput —É–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç—Å—è –∫–æ –≤—Ç–æ—Ä–æ–π –ø–æ–ª–æ–≤–∏–Ω–µ –ø–µ—Ä–∏–æ–¥–∞.'});
  }
  if (m.thTrend < -0.5) {
    patterns.push({name:'–ü–∞–¥–∞—é—â–∏–π Throughput', severity:'bad', desc:'Throughput —Å–Ω–∏–∂–∞–µ—Ç—Å—è –∫–æ –≤—Ç–æ—Ä–æ–π –ø–æ–ª–æ–≤–∏–Ω–µ. –ö–æ–º–∞–Ω–¥–∞ –∑–∞–º–µ–¥–ª—è–µ—Ç—Å—è.'});
  }
  if (m.avgTh < 1) {
    patterns.push({name:'–û—á–µ–Ω—å –Ω–∏–∑–∫–∏–π Throughput', severity:'warn', desc:'–ú–µ–Ω–µ–µ 1 –∑–∞–¥–∞—á–∏ –≤ –¥–µ–Ω—å. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –±–ª–æ–∫–µ—Ä—ã –∏ —Ä–∞–∑–º–µ—Ä –∑–∞–¥–∞—á.'});
  }

  if (patterns.length === 0) {
    patterns.push({name:'–¢–∏–ø–∏—á–Ω—ã–π –ø–æ—Ç–æ–∫', severity:'good', desc:'–Ø–≤–Ω—ã—Ö –∞–Ω–æ–º–∞–ª–∏–π –Ω–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–æ. –ü–æ—Ç–æ–∫ –≤ –ø—Ä–µ–¥–µ–ª–∞—Ö –Ω–æ—Ä–º—ã.'});
  }

  return patterns;
}

// ============================================================
// STEPS
// ============================================================
function buildSteps() {
  return [
    { id:'input', phase:'–í–≤–æ–¥ –¥–∞–Ω–Ω—ã—Ö', type:'input' },
    { id:'theory1', phase:'–¢–µ–æ—Ä–∏—è', type:'theory', title:'–¢—Ä–∏ –º–µ—Ç—Ä–∏–∫–∏ CFD', theory:'–ù–∞ Cumulative Flow Diagram —á–∏—Ç–∞—é—Ç—Å—è <strong>—Ç—Ä–∏ –∫–ª—é—á–µ–≤—ã–µ –º–µ—Ç—Ä–∏–∫–∏</strong>:<br><br><strong>1. WIP</strong> (Work In Progress) ‚Äî –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–æ–µ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ –º–µ–∂–¥—É –≤–µ—Ä—Ö–Ω–µ–π (Arrival) –∏ –Ω–∏–∂–Ω–µ–π (Departure) –ª–∏–Ω–∏—è–º–∏. –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç, —Å–∫–æ–ª—å–∫–æ –∑–∞–¥–∞—á –Ω–∞—á–∞—Ç–æ, –Ω–æ –Ω–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ.<br><br><strong>2. Lead Time</strong> ‚Äî –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ–µ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ –º–µ–∂–¥—É –ª–∏–Ω–∏—è–º–∏ –Ω–∞ –æ–¥–Ω–æ–π –≤—ã—Å–æ—Ç–µ. –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç, —Å–∫–æ–ª—å–∫–æ –≤—Ä–µ–º–µ–Ω–∏ –∑–∞–¥–∞—á–∞ –ø—Ä–æ–≤–æ–¥–∏—Ç –≤ —Å–∏—Å—Ç–µ–º–µ.<br><br><strong>3. Throughput</strong> ‚Äî —É–≥–æ–ª –Ω–∞–∫–ª–æ–Ω–∞ –ª–∏–Ω–∏–∏ Done (Departure Line). –ß–µ–º –∫—Ä—É—á–µ –Ω–∞–∫–ª–æ–Ω, —Ç–µ–º –±—ã—Å—Ç—Ä–µ–µ –∑–∞–≤–µ—Ä—à–∞—é—Ç—Å—è –∑–∞–¥–∞—á–∏.<br><br><strong>–ó–∞–∫–æ–Ω –õ–∏—Ç—Ç–ª–∞:</strong> Lead Time = WIP / Throughput. –≠—Ç–æ —Ñ—É–Ω–¥–∞–º–µ–Ω—Ç–∞–ª—å–Ω–∞—è —Å–≤—è–∑—å. –ß—Ç–æ–±—ã —Å–æ–∫—Ä–∞—Ç–∏—Ç—å Lead Time ‚Äî —Å–Ω–∏–∂–∞–π—Ç–µ WIP –∏–ª–∏ –ø–æ–≤—ã—à–∞–π—Ç–µ Throughput.' },
    { id:'q1', phase:'–ê–Ω–∞–ª–∏–∑', type:'quiz' },
    { id:'q2', phase:'–ê–Ω–∞–ª–∏–∑', type:'quiz' },
    { id:'theory2', phase:'–¢–µ–æ—Ä–∏—è', type:'theory', title:'–ü–∞—Ç—Ç–µ—Ä–Ω—ã CFD', theory:'<strong>–†–∞—Å—Ö–æ–∂–¥–µ–Ω–∏–µ</strong> ‚Äî Arrival Line —Ä–∞—Å—Ç—ë—Ç –±—ã—Å—Ç—Ä–µ–µ Departure Line. WIP –∫–æ–ø–∏—Ç—Å—è. –û–ø–∞—Å–Ω—ã–π —Å–∏–≥–Ω–∞–ª: —Å–∏—Å—Ç–µ–º–∞ –Ω–µ —Å–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è.<br><br><strong>–ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã–µ –ª–∏–Ω–∏–∏</strong> ‚Äî –±–∞–ª–∞–Ω—Å. Arrival Rate = Throughput. –°—Ç–∞–±–∏–ª—å–Ω—ã–π WIP –∏ –ø—Ä–µ–¥—Å–∫–∞–∑—É–µ–º—ã–π Lead Time.<br><br><strong>–õ–µ—Å—Ç–Ω–∏—Ü–∞</strong> ‚Äî –∑–∞–¥–∞—á–∏ –∑–∞–≤–µ—Ä—à–∞—é—Ç—Å—è ¬´–ø–∞—á–∫–∞–º–∏¬ª (–∏—Ç–µ—Ä–∞—Ü–∏–∏/—Å–ø—Ä–∏–Ω—Ç—ã). –¢–∏–ø–∏—á–Ω–æ –¥–ª—è Scrum.<br><br><strong>–†–∞–∑–ª–∏–≤</strong> ‚Äî –ø–æ–ª–æ—Å–∞ WIP —Ä–∞—Å—à–∏—Ä—è–µ—Ç—Å—è. –ó–∞–¥–∞—á–∏ –Ω–∞—á–∏–Ω–∞—é—Ç—Å—è, –Ω–æ –Ω–µ –∑–∞–≤–µ—Ä—à–∞—é—Ç—Å—è. –ù—É–∂–Ω—ã WIP-–ª–∏–º–∏—Ç—ã.<br><br><strong>–ì–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª–∏</strong> ‚Äî –≤—Å–µ –ª–∏–Ω–∏–∏ –ø–ª–æ—Å–∫–∏–µ = –ø–æ–ª–Ω—ã–π –ø—Ä–æ—Å—Ç–æ–π. –û–¥–Ω–∞ –ª–∏–Ω–∏—è –ø–ª–æ—Å–∫–∞—è = –±–ª–æ–∫–µ—Ä –Ω–∞ —ç—Ç–∞–ø–µ.<br><br><strong>–Ø–º–∞</strong> ‚Äî –ª–∏–Ω–∏–∏ –ø–∞–¥–∞—é—Ç –≤–Ω–∏–∑ = –∑–∞–¥–∞—á–∏ —É–¥–∞–ª–µ–Ω—ã –∏–∑ —Å–∏—Å—Ç–µ–º—ã.' },
    { id:'q3', phase:'–ü–∞—Ç—Ç–µ—Ä–Ω—ã', type:'quiz' },
    { id:'q4', phase:'–ü–∞—Ç—Ç–µ—Ä–Ω—ã', type:'quiz' },
    { id:'theory3', phase:'–¢–µ–æ—Ä–∏—è', type:'theory', title:'–ó–∞–∫–æ–Ω –õ–∏—Ç—Ç–ª–∞ –∏ –ø—Ä–æ–≥–Ω–æ–∑–∏—Ä–æ–≤–∞–Ω–∏–µ', theory:'<strong>–ó–∞–∫–æ–Ω –õ–∏—Ç—Ç–ª–∞: LT = WIP / TH</strong><br><br>–≠—Ç–æ –Ω–µ –ø—Ä–æ—Å—Ç–æ —Ñ–æ—Ä–º—É–ª–∞, –∞ –æ—Å–Ω–æ–≤–∞ –ø—Ä–æ–≥–Ω–æ–∑–∏—Ä–æ–≤–∞–Ω–∏—è. –ï—Å–ª–∏ –≤—ã –∑–Ω–∞–µ—Ç–µ —Å—Ä–µ–¥–Ω–∏–π Throughput –∏ –æ—Å—Ç–∞–≤—à–µ–µ—Å—è –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–¥–∞—á, –≤—ã –º–æ–∂–µ—Ç–µ –ø—Ä–µ–¥—Å–∫–∞–∑–∞—Ç—å, –∫–æ–≥–¥–∞ —Ä–∞–±–æ—Ç–∞ –±—É–¥–µ—Ç –∑–∞–≤–µ—Ä—à–µ–Ω–∞:<br><br><strong>–ü—Ä–æ–≥–Ω–æ–∑ = –û—Å—Ç–∞–≤—à–∏–µ—Å—è –∑–∞–¥–∞—á–∏ / –°—Ä–µ–¥–Ω–∏–π Throughput</strong><br><br>–í–∞–∂–Ω—ã–µ –æ–≥–æ–≤–æ—Ä–∫–∏:<br>- –ü—Ä–æ–≥–Ω–æ–∑ —Ä–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —Å–∏—Å—Ç–µ–º–∞ —Å—Ç–∞–±–∏–ª—å–Ω–∞ (–ª–∏–Ω–∏–∏ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã)<br>- –ü—Ä–∏ —Ä–∞—Å—Ö–æ–∂–¥–µ–Ω–∏–∏ –ª–∏–Ω–∏–π –ø—Ä–æ–≥–Ω–æ–∑ –±—É–¥–µ—Ç –æ–ø—Ç–∏–º–∏—Å—Ç–∏—á–Ω—ã–º (—Ä–µ–∞–ª—å–Ω–æ –¥–æ–ª—å—à–µ)<br>- –î–ª—è —Ç–æ—á–Ω–æ–≥–æ –ø—Ä–æ–≥–Ω–æ–∑–∞ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ Monte Carlo —Å–∏–º—É–ª—è—Ü–∏—é<br><br><strong>–î–≤–∞ —Ä—ã—á–∞–≥–∞ —É–ª—É—á—à–µ–Ω–∏—è:</strong><br>1. –°–Ω–∏–∑–∏—Ç—å WIP (–±—ã—Å—Ç—Ä–æ, –±–µ—Å–ø–ª–∞—Ç–Ω–æ, –Ω–∞–¥—ë–∂–Ω–æ) = —Å–Ω–∏–∑–∏—Ç—å Lead Time<br>2. –£–≤–µ–ª–∏—á–∏—Ç—å Throughput (–¥–æ–ª–≥–æ, –¥–æ—Ä–æ–≥–æ, —Ä–∏—Å–∫–æ–≤–∞–Ω–Ω–æ) = —Å–Ω–∏–∑–∏—Ç—å Lead Time' },
    { id:'q5', phase:'–ü—Ä–æ–≥–Ω–æ–∑', type:'quiz' },
    { id:'q6', phase:'–ü—Ä–æ–≥–Ω–æ–∑', type:'quiz' },
    { id:'metrics', phase:'–ú–µ—Ç—Ä–∏–∫–∏', type:'metrics' },
    { id:'report', phase:'–û—Ç—á—ë—Ç', type:'report' }
  ];
}

var STEPS = [];

// ============================================================
// DYNAMIC QUIZ GENERATORS
// ============================================================
function generateQuiz(qIdx) {
  var m = G.metrics;
  var d = G.data;
  if (!m) return null;

  switch(qIdx) {
    case 0:
      return {
        title: '–ö–∞–∫–æ–≤ —Å—Ä–µ–¥–Ω–∏–π WIP –≤–∞—à–µ–π –∫–æ–º–∞–Ω–¥—ã?',
        context: '–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π—Ç–µ –≤–∞—à—É CFD.',
        scenario: '–ü–æ—Å–º–æ—Ç—Ä–∏—Ç–µ –Ω–∞ –≤–∞—à—É –¥–∏–∞–≥—Ä–∞–º–º—É. –û—Ü–µ–Ω–∏—Ç–µ <strong>—Å—Ä–µ–¥–Ω–µ–µ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ –ø–æ –≤–µ—Ä—Ç–∏–∫–∞–ª–∏</strong> –º–µ–∂–¥—É –≤–µ—Ä—Ö–Ω–µ–π –∏ –Ω–∏–∂–Ω–µ–π –ª–∏–Ω–∏—è–º–∏. –≠—Ç–æ –≤–∞—à —Å—Ä–µ–¥–Ω–∏–π WIP.',
        correct: 0,
        options: [
          { text: '–°—Ä–µ–¥–Ω–∏–π WIP = '+m.avgWip+'. –≠—Ç–æ –≤–∏–¥–Ω–æ –ø–æ –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–æ–º—É —Ä–∞—Å—Å—Ç–æ—è–Ω–∏—é –º–µ–∂–¥—É Arrival –∏ Departure Line', q:'best', fb:'–í–µ—Ä–Ω–æ! –í—ã —Ç–æ—á–Ω–æ –ø—Ä–æ—á–∏—Ç–∞–ª–∏ WIP —Å –¥–∏–∞–≥—Ä–∞–º–º—ã. –í–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–æ–µ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ –º–µ–∂–¥—É –ª–∏–Ω–∏—è–º–∏ = –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–¥–∞—á –≤ —Ä–∞–±–æ—Ç–µ.' },
          { text: 'WIP –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –Ω–µ–≤–æ–∑–º–æ–∂–Ω–æ ‚Äî –Ω—É–∂–Ω—ã –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ', q:'bad', fb:'WIP –≤—Å–µ–≥–¥–∞ –≤–∏–¥–µ–Ω –Ω–∞ CFD! –≠—Ç–æ –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–æ–µ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ –º–µ–∂–¥—É –≤–µ—Ä—Ö–Ω–µ–π –∏ –Ω–∏–∂–Ω–µ–π –≥—Ä–∞–Ω–∏—Ü–∞–º–∏. –ü–æ –≤–∞—à–∏–º –¥–∞–Ω–Ω—ã–º WIP = '+m.avgWip+'.' },
          { text: 'WIP = '+m.totalDone+' ‚Äî —Å—Ç–æ–ª—å–∫–æ –∑–∞–¥–∞—á –±—ã–ª–æ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ', q:'bad', fb:'–ù–µ—Ç, '+m.totalDone+' ‚Äî —ç—Ç–æ Throughput –∑–∞ –≤–µ—Å—å –ø–µ—Ä–∏–æ–¥ (—Å–∫–æ–ª—å–∫–æ –∑–∞–≤–µ—Ä—à–∏–ª–∏), –∞ –Ω–µ WIP. WIP ‚Äî —ç—Ç–æ –∑–∞–¥–∞—á–∏ –í –†–ê–ë–û–¢–ï, –Ω–µ –∑–∞–≤–µ—Ä—à—ë–Ω–Ω—ã–µ.' },
        ]
      };

    case 1:
      var ltRound = Math.round(m.avgLT*10)/10;
      var ltWrong1 = Math.round(m.avgWip * m.avgTh * 10)/10;
      var ltWrong2 = Math.round(m.avgTh * 10)/10;
      return {
        title: '–†–∞—Å—Å—á–∏—Ç–∞–π—Ç–µ Lead Time –ø–æ –∑–∞–∫–æ–Ω—É –õ–∏—Ç—Ç–ª–∞',
        context: 'WIP = '+m.avgWip+', Throughput = '+m.avgTh+' –∑–∞–¥–∞—á/–¥–µ–Ω—å.',
        scenario: '–ò—Å–ø–æ–ª—å–∑—É—è –¥–∞–Ω–Ω—ã–µ –≤–∞—à–µ–π CFD, —Ä–∞—Å—Å—á–∏—Ç–∞–π—Ç–µ <strong>—Å—Ä–µ–¥–Ω–∏–π Lead Time</strong> –ø–æ –∑–∞–∫–æ–Ω—É –õ–∏—Ç—Ç–ª–∞. –§–æ—Ä–º—É–ª–∞: Lead Time = WIP / Throughput.',
        correct: 0,
        options: [
          { text: 'Lead Time = '+m.avgWip+' / '+m.avgTh+' = '+ltRound+' –¥–Ω–µ–π', q:'best', fb:'–í–µ—Ä–Ω–æ! –ó–∞–∫–æ–Ω –õ–∏—Ç—Ç–ª–∞: LT = WIP / TH = '+m.avgWip+' / '+m.avgTh+' = '+ltRound+' –¥–Ω–µ–π. –≠—Ç–æ —Å—Ä–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è –∑–∞–¥–∞—á–∏ –≤ —Å–∏—Å—Ç–µ–º–µ.' },
          { text: 'Lead Time = '+m.avgWip+' x '+m.avgTh+' = '+ltWrong1+' –¥–Ω–µ–π', q:'bad', fb:'–û—à–∏–±–∫–∞! Lead Time = WIP / Throughput (–¥–µ–ª–µ–Ω–∏–µ, –Ω–µ —É–º–Ω–æ–∂–µ–Ω–∏–µ). –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç: '+ltRound+' –¥–Ω–µ–π.' },
          { text: 'Lead Time = Throughput = '+ltWrong2+' –¥–Ω–µ–π', q:'bad', fb:'Lead Time –∏ Throughput ‚Äî —Ä–∞–∑–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏! LT = WIP / TH = '+ltRound+' –¥–Ω–µ–π.' },
        ]
      };

    case 2: {
      var patterns = detectPatterns(d, m);
      var mainPattern = patterns[0];
      var wrongPatterns = ['–õ–µ—Å—Ç–Ω–∏—Ü–∞ (–∏—Ç–µ—Ä–∞—Ç–∏–≤–Ω—ã–π –ø—Ä–æ—Ü–µ—Å—Å)', '–ò–¥–µ–∞–ª—å–Ω—ã–π –±–∞–ª–∞–Ω—Å –±–µ–∑ –∞–Ω–æ–º–∞–ª–∏–π', '–ö–∞—Å–∫–∞–¥–Ω—ã–π –æ—Ç–∫–∞–∑ —Å–∏—Å—Ç–µ–º—ã'];
      return {
        title: '–ö–∞–∫–æ–π –≥–ª–∞–≤–Ω—ã–π –ø–∞—Ç—Ç–µ—Ä–Ω –≤—ã –≤–∏–¥–∏—Ç–µ?',
        context: '–í–Ω–∏–º–∞—Ç–µ–ª—å–Ω–æ –ø–æ—Å–º–æ—Ç—Ä–∏—Ç–µ –Ω–∞ —Ñ–æ—Ä–º—É –≤–∞—à–µ–π CFD.',
        scenario: '–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π—Ç–µ <strong>—Ñ–æ—Ä–º—É –ª–∏–Ω–∏–π</strong> –Ω–∞ –≤–∞—à–µ–π –¥–∏–∞–≥—Ä–∞–º–º–µ. –†–∞—Å—Ö–æ–¥—è—Ç—Å—è –ª–∏ –ª–∏–Ω–∏–∏? –ï—Å—Ç—å –ª–∏ –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª–∏? –†–∞—Å—à–∏—Ä—è–µ—Ç—Å—è –ª–∏ –ø–æ–ª–æ—Å–∞ WIP? –û–ø—Ä–µ–¥–µ–ª–∏—Ç–µ <strong>–æ—Å–Ω–æ–≤–Ω–æ–π –ø–∞—Ç—Ç–µ—Ä–Ω</strong>.',
        correct: 0,
        options: [
          { text: mainPattern.name+': '+mainPattern.desc, q:'best', fb:'–í–µ—Ä–Ω–æ! –í—ã –ø—Ä–∞–≤–∏–ª—å–Ω–æ –æ–ø—Ä–µ–¥–µ–ª–∏–ª–∏ –æ—Å–Ω–æ–≤–Ω–æ–π –ø–∞—Ç—Ç–µ—Ä–Ω –≤–∞—à–µ–π CFD. '+mainPattern.desc },
          { text: wrongPatterns[Math.floor(Math.random()*wrongPatterns.length)], q:'bad', fb:'–ù–µ —Å–æ–≤—Å–µ–º. –û—Å–Ω–æ–≤–Ω–æ–π –ø–∞—Ç—Ç–µ—Ä–Ω –≤–∞—à–µ–π –¥–∏–∞–≥—Ä–∞–º–º—ã: '+mainPattern.name+'. '+mainPattern.desc },
          { text: '–ù–µ—Ç —è–≤–Ω—ã—Ö –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤ ‚Äî –¥–∞–Ω–Ω—ã—Ö –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ', q:'ok', fb:'21 –¥–µ–Ω—å ‚Äî –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–ª—è –±–∞–∑–æ–≤–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞. –ù–∞ –≤–∞—à–µ–π –¥–∏–∞–≥—Ä–∞–º–º–µ –≤–∏–¥–µ–Ω –ø–∞—Ç—Ç–µ—Ä–Ω: '+mainPattern.name+'.' },
        ]
      };
    }

    case 3: {
      var trendWord = m.wipTrend > 1.5 ? '—Ä–∞—Å—Ç—ë—Ç' : m.wipTrend < -1.5 ? '—Å–Ω–∏–∂–∞–µ—Ç—Å—è' : '—Å—Ç–∞–±–∏–ª–µ–Ω';
      var trendAdvice = m.wipTrend > 1.5
        ? '–†–∞—Å—Ö–æ–∂–¥–µ–Ω–∏–µ –Ω–∞—Ä–∞—Å—Ç–∞–µ—Ç. –í–≤–µ–¥–∏—Ç–µ WIP-–ª–∏–º–∏—Ç—ã.'
        : m.wipTrend < -1.5
          ? 'WIP —Å–Ω–∏–∂–∞–µ—Ç—Å—è ‚Äî –ø–æ—Ç–æ–∫ —É–ª—É—á—à–∞–µ—Ç—Å—è.'
          : 'WIP —Å—Ç–∞–±–∏–ª–µ–Ω ‚Äî —Ö–æ—Ä–æ—à–∏–π –∑–Ω–∞–∫ –ø—Ä–µ–¥—Å–∫–∞–∑—É–µ–º–æ—Å—Ç–∏.';
      return {
        title: '–ö–∞–∫ –º–µ–Ω—è–µ—Ç—Å—è WIP –≤ –≤–∞—à–µ–π —Å–∏—Å—Ç–µ–º–µ?',
        context: '–°—Ä–∞–≤–Ω–∏—Ç–µ –ø–µ—Ä–≤—É—é –∏ –≤—Ç–æ—Ä—É—é –ø–æ–ª–æ–≤–∏–Ω—É –ø–µ—Ä–∏–æ–¥–∞.',
        scenario: '–ü–æ—Å–º–æ—Ç—Ä–∏—Ç–µ –Ω–∞ <strong>—à–∏—Ä–∏–Ω—É –ø–æ–ª–æ—Å—ã In Progress</strong> –≤ –Ω–∞—á–∞–ª–µ –∏ –≤ –∫–æ–Ω—Ü–µ –ø–µ—Ä–∏–æ–¥–∞. WIP <strong>'+trendWord+'</strong> (—Ç—Ä–µ–Ω–¥: '+(m.wipTrend>0?'+':'')+m.wipTrend+'). –ß—Ç–æ —ç—Ç–æ –æ–∑–Ω–∞—á–∞–µ—Ç?',
        correct: 0,
        options: [
          { text: 'WIP '+trendWord+'. '+trendAdvice, q:'best', fb:'–í–µ—Ä–Ω–æ! '+trendAdvice+' –¢—Ä–µ–Ω–¥ WIP: '+(m.wipTrend>0?'+':'')+m.wipTrend+' –∑–∞–¥–∞—á –æ—Ç –ø–µ—Ä–≤–æ–π –∫–æ –≤—Ç–æ—Ä–æ–π –ø–æ–ª–æ–≤–∏–Ω–µ.' },
          { text: '–¢—Ä–µ–Ω–¥ WIP –Ω–µ –≤–∞–∂–µ–Ω ‚Äî –≥–ª–∞–≤–Ω–æ–µ Throughput', q:'ok', fb:'–¢—Ä–µ–Ω–¥ WIP –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –≤–∞–∂–µ–Ω! –†–∞—Å—Ç—É—â–∏–π WIP = —Ä–∞—Å—Ç—É—â–∏–π Lead Time (–∑–∞–∫–æ–Ω –õ–∏—Ç—Ç–ª–∞). WIP '+trendWord+': —Ç—Ä–µ–Ω–¥ '+(m.wipTrend>0?'+':'')+m.wipTrend+'.' },
          { text: 'WIP –Ω–µ –º–µ–Ω—è–µ—Ç—Å—è ‚Äî –ª–∏–Ω–∏–∏ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã', q: Math.abs(m.wipTrend) < 1.5 ? 'best' : 'bad', fb: Math.abs(m.wipTrend)<1.5 ? '–í–µ—Ä–Ω–æ! WIP —Å—Ç–∞–±–∏–ª–µ–Ω.' : '–ù–µ—Ç, WIP '+trendWord+'. –¢—Ä–µ–Ω–¥: '+(m.wipTrend>0?'+':'')+m.wipTrend+'. –ü–æ—Å–º–æ—Ç—Ä–∏—Ç–µ –≤–Ω–∏–º–∞—Ç–µ–ª—å–Ω–µ–µ –Ω–∞ —à–∏—Ä–∏–Ω—É –ø–æ–ª–æ—Å—ã WIP.' },
        ]
      };
    }

    case 4: {
      var fcDays = m.forecastDays;
      var fcText = fcDays === Infinity ? '–Ω–µ–≤–æ–∑–º–æ–∂–Ω–æ (Throughput = 0)' : fcDays + ' –¥–Ω–µ–π';
      return {
        title: '–ö–æ–≥–¥–∞ –∑–∞–≤–µ—Ä—à–∏—Ç—Å—è –æ—Å—Ç–∞–≤—à–∞—è—Å—è —Ä–∞–±–æ—Ç–∞?',
        context: '–û—Å—Ç–∞–≤—à–∏–µ—Å—è –∑–∞–¥–∞—á–∏: '+m.remaining+', —Å—Ä–µ–¥–Ω–∏–π Throughput: '+m.avgTh+'/–¥–µ–Ω—å.',
        scenario: '–í –∫–æ–Ω—Ü–µ 21-–≥–æ –¥–Ω—è —É –≤–∞—Å <strong>'+m.remaining+' –Ω–µ–∑–∞–≤–µ—Ä—à—ë–Ω–Ω—ã—Ö –∑–∞–¥–∞—á</strong> (ToDo + In Progress). –ü—Ä–∏ —Å—Ä–µ–¥–Ω–µ–º Throughput <strong>'+m.avgTh+' –∑–∞–¥–∞—á/–¥–µ–Ω—å</strong>, —Å–∫–æ–ª—å–∫–æ –¥–Ω–µ–π –ø–æ–Ω–∞–¥–æ–±–∏—Ç—Å—è –¥–ª—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è?',
        correct: 0,
        options: [
          { text: '–ü—Ä–æ–≥–Ω–æ–∑: '+m.remaining+' / '+m.avgTh+' = '+fcText, q:'best', fb:'–í–µ—Ä–Ω–æ! –ü—Ä–æ—Å—Ç–æ–π –ø—Ä–æ–≥–Ω–æ–∑: –æ—Å—Ç–∞–≤—à–∞—è—Å—è —Ä–∞–±–æ—Ç–∞ / Throughput = '+fcText+'. –ù–æ –ø–æ–º–Ω–∏—Ç–µ: —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ –ø—Ä–∏ —Å—Ç–∞–±–∏–ª—å–Ω–æ–º –ø–æ—Ç–æ–∫–µ!' },
          { text: '–ù–µ–≤–æ–∑–º–æ–∂–Ω–æ –ø—Ä–æ–≥–Ω–æ–∑–∏—Ä–æ–≤–∞—Ç—å ‚Äî –¥–∞–Ω–Ω—ã—Ö –º–∞–ª–æ', q:'ok', fb:'21 –¥–µ–Ω—å ‚Äî –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–ª—è –±–∞–∑–æ–≤–æ–π –æ—Ü–µ–Ω–∫–∏. –ü—Ä–æ–≥–Ω–æ–∑: '+fcText+'. –î–ª—è —Ç–æ—á–Ω–æ—Å—Ç–∏ –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å Monte Carlo —Å–∏–º—É–ª—è—Ü–∏—é.' },
          { text: '–ü—Ä–æ–≥–Ω–æ–∑ = '+m.remaining+' x '+m.avgTh+' = '+Math.round(m.remaining*m.avgTh)+' –¥–Ω–µ–π', q:'bad', fb:'–û—à–∏–±–∫–∞! –ü—Ä–æ–≥–Ω–æ–∑ = –û—Å—Ç–∞—Ç–æ–∫ / Throughput (–¥–µ–ª–µ–Ω–∏–µ). –ü—Ä–∞–≤–∏–ª—å–Ω–æ: '+fcText+'.' },
        ]
      };
    }

    case 5: {
      var wipHigh = m.avgWip > 10;
      var diverging = m.isDiverging;
      var bestAction = wipHigh || diverging
        ? '–í–≤–µ—Å—Ç–∏ WIP-–ª–∏–º–∏—Ç (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–π: '+Math.max(3,Math.round(m.avgWip*0.6))+') –¥–ª—è —Å–Ω–∏–∂–µ–Ω–∏—è Lead Time'
        : '–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—Ç—å —Ç–µ–∫—É—â–∏–π –±–∞–ª–∞–Ω—Å –∏ —Ñ–æ–∫—É—Å–∏—Ä–æ–≤–∞—Ç—å—Å—è –Ω–∞ —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏ Throughput';
      var bestFb = wipHigh || diverging
        ? '–í–µ—Ä–Ω–æ! WIP-–ª–∏–º–∏—Ç ‚Äî —Å–∞–º—ã–π –Ω–∞–¥—ë–∂–Ω—ã–π —Ä—ã—á–∞–≥. –ü—Ä–∏ WIP '+Math.max(3,Math.round(m.avgWip*0.6))+' –ø—Ä–æ–≥–Ω–æ–∑–Ω—ã–π Lead Time: '+Math.round(Math.max(3,Math.round(m.avgWip*0.6))/m.avgTh*10)/10+' –¥–Ω–µ–π.'
        : '–í–µ—Ä–Ω–æ! –ü—Ä–∏ —Å—Ç–∞–±–∏–ª—å–Ω–æ–º –ø–æ—Ç–æ–∫–µ –≥–ª–∞–≤–Ω–æ–µ ‚Äî –Ω–µ –ª–æ–º–∞—Ç—å —Ç–æ, —á—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç. –§–æ–∫—É—Å –Ω–∞ –ø—Ä–µ–¥—Å–∫–∞–∑—É–µ–º–æ—Å—Ç–∏.';
      return {
        title: '–ß—Ç–æ –≤—ã –ø–æ—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç–µ –∫–æ–º–∞–Ω–¥–µ?',
        context: '–ù–∞ –æ—Å–Ω–æ–≤–µ –≤—Å–µ–≥–æ –∞–Ω–∞–ª–∏–∑–∞ –≤–∞—à–µ–π CFD.',
        scenario: '–í—ã –ø—Ä–æ–≤–µ–ª–∏ –ø–æ–ª–Ω—ã–π –∞–Ω–∞–ª–∏–∑: WIP = '+m.avgWip+', Lead Time = '+m.avgLT+' –¥–Ω., Throughput = '+m.avgTh+'/–¥–µ–Ω—å, —Ç—Ä–µ–Ω–¥ WIP: '+(m.wipTrend>0?'+':'')+m.wipTrend+'. <strong>–ö–∞–∫–æ–π –≥–ª–∞–≤–Ω—ã–π —Å–æ–≤–µ—Ç?</strong>',
        correct: 0,
        options: [
          { text: bestAction, q:'best', fb: bestFb },
          { text: '–ù–∞–Ω—è—Ç—å –±–æ–ª—å—à–µ –ª—é–¥–µ–π –¥–ª—è —É–≤–µ–ª–∏—á–µ–Ω–∏—è Throughput', q:'bad', fb:'–ù–∞—ë–º ‚Äî –¥–æ—Ä–æ–≥–æ–π –∏ –º–µ–¥–ª–µ–Ω–Ω—ã–π —Ä—ã—á–∞–≥. –ù–æ–≤—ã–µ –ª—é–¥–∏ —Å–Ω–∞—á–∞–ª–∞ –∑–∞–º–µ–¥–ª—è—é—Ç (onboarding). –°–Ω–∏–∂–µ–Ω–∏–µ WIP ‚Äî –±—ã—Å—Ç—Ä–µ–µ –∏ –±–µ—Å–ø–ª–∞—Ç–Ω–æ.' },
          { text: '–†–∞–±–æ—Ç–∞—Ç—å –ø–æ –≤—ã—Ö–æ–¥–Ω—ã–º, —á—Ç–æ–±—ã —Å–æ–∫—Ä–∞—Ç–∏—Ç—å Lead Time', q:'bad', fb:'–ü–µ—Ä–µ—Ä–∞–±–æ—Ç–∫–∏ —Å–Ω–∏–∂–∞—é—Ç –∫–∞—á–µ—Å—Ç–≤–æ –∏ —É–≤–µ–ª–∏—á–∏–≤–∞—é—Ç WIP (–±–æ–ª—å—à–µ –±–∞–≥–æ–≤ = –±–æ–ª—å—à–µ —Ä–∞–±–æ—Ç—ã). –≠—Ç–æ –ø–µ—Ç–ª—è –¥–µ–≥—Ä–∞–¥–∞—Ü–∏–∏, –∞ –Ω–µ —Ä–µ—à–µ–Ω–∏–µ.' },
        ]
      };
    }
  }
  return null;
}

// ============================================================
// RENDERING
// ============================================================
function renderProgress() {
  var dots = document.getElementById('progDots');
  dots.innerHTML = STEPS.map(function(_,i){
    var cls = i < G.step ? 'done' : i === G.step ? 'current' : '';
    return '<div class="p-dot '+cls+'"></div>';
  }).join('');
  document.getElementById('scoreDisp').textContent = G.score + ' pts';
  if (STEPS[G.step]) document.getElementById('phaseBadge').textContent = STEPS[G.step].phase;
}

function showStep() {
  if (G.step >= STEPS.length) { finishGame(); return; }
  G.answered = false;
  var step = STEPS[G.step];
  renderProgress();

  switch(step.type) {
    case 'input': renderInputStep(); break;
    case 'theory': renderTheoryStep(step); break;
    case 'quiz': renderQuizStep(); break;
    case 'metrics': renderMetricsStep(); break;
    case 'report': renderReportStep(); break;
  }
  window.scrollTo(0, 0);
}

// ---- INPUT STEP ----
function renderInputStep() {
  var area = document.getElementById('mainArea');
  var rows = '';
  for (var d=1; d<=DAYS; d++) {
    rows += '<tr><td>–î–µ–Ω—å '+d+'</td>'
      +'<td><input type="number" min="0" id="td'+d+'" placeholder="0" oninput="onDataInput()"></td>'
      +'<td><input type="number" min="0" id="wp'+d+'" placeholder="0" oninput="onDataInput()"></td>'
      +'<td><input type="number" min="0" id="dn'+d+'" placeholder="0" oninput="onDataInput()"></td>'
      +'<td class="calc-cell calc-wip" id="wip'+d+'">-</td>'
      +'<td class="calc-cell calc-th" id="th'+d+'">-</td></tr>';
  }
  area.innerHTML = '<div class="content-card"><div class="cc-header"><span class="cc-type type-input">–í–≤–æ–¥ –¥–∞–Ω–Ω—ã—Ö</span><div><div class="cc-title">–í–≤–µ–¥–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ –≤–∞—à–µ–π CFD</div><div class="cc-desc">–ó–∞–ø–æ–ª–Ω–∏—Ç–µ —Ç–∞–±–ª–∏—Ü—É –¥–∞–Ω–Ω—ã–º–∏ –∏–∑ –≤–∞—à–µ–π Lean Flow Simulation –∑–∞ 21 –¥–µ–Ω—å</div></div></div>'
    +'<div class="cc-body">'
    +'<div class="tip-box"><strong>–ü–æ–¥—Å–∫–∞–∑–∫–∞:</strong> –í–≤–µ–¥–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–¥–∞—á –≤ –∫–∞–∂–¥–æ–º —Å—Ç–∞—Ç—É—Å–µ –Ω–∞ –∫–æ–Ω–µ—Ü –∫–∞–∂–¥–æ–≥–æ –¥–Ω—è. ToDo = –∑–∞–¥–∞—á–∏ –≤ –±—ç–∫–ª–æ–≥–µ. In Progress = –∑–∞–¥–∞—á–∏ –≤ —Ä–∞–±–æ—Ç–µ. Done = –∑–∞–≤–µ—Ä—à—ë–Ω–Ω—ã–µ –∑–∞–¥–∞—á–∏ (–∫—É–º—É–ª—è—Ç–∏–≤–Ω–æ).</div>'
    +'<div class="chart-container"><canvas id="liveChart"></canvas>'
    +'<div class="chart-legend"><div class="leg"><div class="leg-dot" style="background:var(--todo-color);"></div>ToDo</div><div class="leg"><div class="leg-dot" style="background:var(--wip-color);"></div>In Progress</div><div class="leg"><div class="leg-dot" style="background:var(--done-color);"></div>Done</div></div></div>'
    +'<div class="data-table-wrap"><table class="data-table"><thead><tr><th>–î–µ–Ω—å</th><th>ToDo</th><th>In Prog</th><th>Done</th><th>WIP</th><th>TH/–¥–µ–Ω—å</th></tr></thead><tbody>'+rows+'</tbody></table></div>'
    +'<div id="inputError" style="color:var(--accent-red);font-size:.8rem;margin-bottom:10px;display:none;"></div>'
    +'<div class="btn-row"><button class="btn btn-ghost" onclick="fillSampleData()">üìã –ó–∞–ø–æ–ª–Ω–∏—Ç—å –ø—Ä–∏–º–µ—Ä–æ–º</button><button class="btn btn-primary" id="btnSubmitData" onclick="submitData()" disabled>‚ñ∂ –ù–∞—á–∞—Ç—å –∞–Ω–∞–ª–∏–∑</button></div>'
    +'</div></div>';

  // Auto-fill if preset selected
  if (G.selectedDataset !== 'custom') {
    var ds = DATASETS.find(function(d){ return d.id === G.selectedDataset; });
    if (ds && ds.data) {
      fillFromDataset(ds.data);
    }
  }
}

function fillFromDataset(sample) {
  for (var d=1; d<=DAYS; d++) {
    document.getElementById('td'+d).value = sample.todo[d-1];
    document.getElementById('wp'+d).value = sample.wip[d-1];
    document.getElementById('dn'+d).value = sample.done[d-1];
  }
  onDataInput();
}

function onDataInput() {
  var data = readInputData();
  if (!data) return;

  for (var i=0; i<data.done.length; i++) {
    var wip = data.wip[i];
    document.getElementById('wip'+(i+1)).textContent = wip;
    if (i > 0) {
      var th = Math.max(0, data.done[i] - data.done[i-1]);
      document.getElementById('th'+(i+1)).textContent = th;
    } else {
      document.getElementById('th1').textContent = '-';
    }
  }

  var canvas = document.getElementById('liveChart');
  if (canvas && data.done.length >= 2) {
    renderCFD(canvas, data);
  }

  var filled = 0;
  for (var j=0; j<DAYS; j++) {
    if (!isNaN(data.todo[j]) && !isNaN(data.wip[j]) && !isNaN(data.done[j])) filled++;
  }
  document.getElementById('btnSubmitData').disabled = filled < DAYS;
}

function readInputData() {
  var todo=[], wip=[], done=[];
  for (var d=1; d<=DAYS; d++) {
    var t = parseInt(document.getElementById('td'+d).value) || 0;
    var w = parseInt(document.getElementById('wp'+d).value) || 0;
    var dn = parseInt(document.getElementById('dn'+d).value) || 0;
    todo.push(t); wip.push(w); done.push(dn);
  }
  return {todo:todo, wip:wip, done:done};
}

function fillSampleData() {
  var sample = {
    todo:[15,14,13,11,10,9,9,8,7,7,8,7,6,5,5,4,4,3,3,2,1],
    wip: [0, 1, 3, 4, 5, 5, 4, 5, 6, 5,4,5,5,5,4,4,3,4,3,3,2],
    done:[0, 0, 0, 1, 2, 3, 5, 6, 7, 9,10,11,13,14,16,17,19,20,22,23,25]
  };
  fillFromDataset(sample);
}

function submitData() {
  var data = readInputData();

  var errEl = document.getElementById('inputError');
  for (var i=1; i<DAYS; i++) {
    if (data.done[i] < data.done[i-1]) {
      errEl.textContent = 'Done –Ω–∞ –¥–µ–Ω—å '+(i+1)+' –º–µ–Ω—å—à–µ, —á–µ–º –Ω–∞ –¥–µ–Ω—å '+i+'. Done ‚Äî –∫—É–º—É–ª—è—Ç–∏–≤–Ω–∞—è –º–µ—Ç—Ä–∏–∫–∞ (–Ω–µ –º–æ–∂–µ—Ç —É–º–µ–Ω—å—à–∞—Ç—å—Å—è).';
      errEl.style.display = 'block';
      return;
    }
  }
  errEl.style.display = 'none';

  G.data = data;
  G.metrics = calcMetrics(data);
  G.step++;
  showStep();
}

// ---- THEORY STEP ----
function renderTheoryStep(step) {
  var area = document.getElementById('mainArea');
  area.innerHTML = '<div class="content-card"><div class="cc-header"><span class="cc-type type-theory">–¢–µ–æ—Ä–∏—è</span><div><div class="cc-title">'+step.title+'</div></div></div>'
    +'<div class="cc-body">'
    +'<div class="chart-container"><canvas id="theoryChart"></canvas>'
    +'<div class="chart-legend"><div class="leg"><div class="leg-dot" style="background:var(--todo-color);"></div>ToDo</div><div class="leg"><div class="leg-dot" style="background:var(--wip-color);"></div>In Progress</div><div class="leg"><div class="leg-dot" style="background:var(--done-color);"></div>Done</div></div></div>'
    +'<div class="theory-card"><div class="th-title">–¢–µ–æ—Ä–∏—è CFD</div>'+step.theory+'</div>'
    +'<button class="btn btn-primary" onclick="nextStep()" style="width:100%;justify-content:center;">‚û°Ô∏è –î–∞–ª–µ–µ</button>'
    +'</div></div>';
  setTimeout(function(){
    var c = document.getElementById('theoryChart');
    if(c && G.data) renderCFD(c, G.data);
  }, 50);
}

// ---- QUIZ STEP ----
var quizCounter = 0;
function renderQuizStep() {
  var qData = generateQuiz(quizCounter);
  quizCounter++;
  if (!qData) { nextStep(); return; }

  var indices = qData.options.map(function(_,i){return i;});
  for(var i=indices.length-1;i>0;i--){var j=Math.floor(Math.random()*(i+1));var tmp=indices[i];indices[i]=indices[j];indices[j]=tmp;}

  var letters = ['A','B','C'];
  var optsHtml = indices.map(function(oi, di){
    return '<button class="opt-btn" data-di="'+di+'" data-oi="'+oi+'" onclick="handleQuizAnswer('+di+','+oi+')"><span class="opt-letter">'+letters[di]+'</span><span>'+qData.options[oi].text+'</span></button>';
  }).join('');

  var area = document.getElementById('mainArea');
  area.innerHTML = '<div class="content-card"><div class="cc-header"><span class="cc-type type-quiz">–í–æ–ø—Ä–æ—Å</span><div><div class="cc-title">'+qData.title+'</div><div class="cc-desc">'+qData.context+'</div></div></div>'
    +'<div class="cc-body">'
    +'<div class="cc-desc" style="padding:14px 16px;background:var(--bg-column);border-radius:8px;border:1px solid rgba(255,255,255,.08);margin-bottom:14px;">'+qData.scenario+'</div>'
    +'<div class="chart-container"><canvas id="quizChart"></canvas>'
    +'<div class="chart-legend"><div class="leg"><div class="leg-dot" style="background:var(--todo-color);"></div>ToDo</div><div class="leg"><div class="leg-dot" style="background:var(--wip-color);"></div>In Progress</div><div class="leg"><div class="leg-dot" style="background:var(--done-color);"></div>Done</div></div></div>'
    +'<div class="options-list" id="optList">'+optsHtml+'</div>'
    +'<div class="fb-box" id="fbBox"></div>'
    +'<div id="qActions"></div>'
    +'</div></div>';

  window._currentQuiz = qData;
  window._currentIndices = indices;

  setTimeout(function(){
    var c = document.getElementById('quizChart');
    if(c && G.data) renderCFD(c, G.data);
  }, 50);
}

function handleQuizAnswer(di, oi) {
  if (G.answered) return;
  G.answered = true;
  var q = window._currentQuiz;
  var opt = q.options[oi];

  var btns = document.querySelectorAll('#optList .opt-btn');
  btns.forEach(function(btn){
    btn.onclick = null; btn.style.cursor = 'default';
    var boi = parseInt(btn.dataset.oi);
    var bdi = parseInt(btn.dataset.di);
    var bq = q.options[boi].q;
    if(bdi === di) btn.classList.add(bq==='best'?'c-best':bq==='ok'?'c-ok':'c-bad');
    else btn.classList.add('c-dim');
  });

  var pts = opt.q==='best'?10:opt.q==='ok'?4:-2;
  G.score += pts;
  if(opt.q==='best') G.best++; else if(opt.q==='ok') G.ok++; else G.bad++;

  var fb = document.getElementById('fbBox');
  var fbClass = opt.q==='best'?'fb-great':opt.q==='ok'?'fb-ok':'fb-bad';
  var fbTitle = opt.q==='best'?'–í–µ—Ä–Ω–æ!':opt.q==='ok'?'–ù–µ–ø–ª–æ—Ö–æ, –Ω–æ –µ—Å—Ç—å –Ω—é–∞–Ω—Å':'–ù–µ–≤–µ—Ä–Ω–æ';
  fb.className = 'fb-box '+fbClass+' show';
  fb.innerHTML = '<div class="fb-title">'+fbTitle+' ('+(pts>0?'+':'')+pts+' pts)</div>'+opt.fb;

  document.getElementById('qActions').innerHTML = '<button class="btn btn-primary" onclick="nextStep()" style="width:100%;margin-top:10px;justify-content:center;">‚û°Ô∏è –î–∞–ª–µ–µ</button>';
  document.getElementById('scoreDisp').textContent = G.score + ' pts';
}

// ---- METRICS STEP ----
function renderMetricsStep() {
  var m = G.metrics;
  var patterns = detectPatterns(G.data, m);

  var patternTags = patterns.map(function(p){
    var cls = p.severity==='good'?'pt-good':p.severity==='warn'?'pt-warn':'pt-bad';
    return '<span class="pattern-tag '+cls+'">'+p.name+'</span>';
  }).join(' ');

  var ltColor = m.avgLT > 15 ? 'v-warn' : m.avgLT > 8 ? 'v-orange' : 'v-green';
  var wipColor = m.avgWip > 15 ? 'v-warn' : m.avgWip > 8 ? 'v-orange' : 'v-green';

  var area = document.getElementById('mainArea');
  area.innerHTML = '<div class="content-card"><div class="cc-header"><span class="cc-type type-report">–ú–µ—Ç—Ä–∏–∫–∏</span><div><div class="cc-title">–í–∞—à–∏ –∫–ª—é—á–µ–≤—ã–µ –º–µ—Ç—Ä–∏–∫–∏</div><div class="cc-desc">–†–∞—Å—á—ë—Ç –Ω–∞ –æ—Å–Ω–æ–≤–µ –≤–≤–µ–¥—ë–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –∑–∞ 21 –¥–µ–Ω—å</div></div></div>'
    +'<div class="cc-body">'
    +'<div class="chart-container"><canvas id="metricsChart"></canvas>'
    +'<div class="chart-legend"><div class="leg"><div class="leg-dot" style="background:var(--todo-color);"></div>ToDo</div><div class="leg"><div class="leg-dot" style="background:var(--wip-color);"></div>In Progress</div><div class="leg"><div class="leg-dot" style="background:var(--done-color);"></div>Done</div></div></div>'
    +'<div class="metrics-grid">'
    +'<div class="metric-card"><div class="metric-val '+wipColor+'">'+m.avgWip+'</div><div class="metric-label">–°—Ä–µ–¥–Ω–∏–π WIP</div></div>'
    +'<div class="metric-card"><div class="metric-val v-blue">'+m.avgTh+'</div><div class="metric-label">Throughput/–¥–µ–Ω—å</div></div>'
    +'<div class="metric-card"><div class="metric-val '+ltColor+'">'+m.avgLT+'</div><div class="metric-label">Lead Time (–¥–Ω–∏)</div></div>'
    +'<div class="metric-card"><div class="metric-val v-purple">'+m.totalDone+'</div><div class="metric-label">–í—Å–µ–≥–æ –∑–∞–≤–µ—Ä—à–µ–Ω–æ</div></div>'
    +'<div class="metric-card"><div class="metric-val v-cyan">'+(m.wipTrend>0?'+':'')+m.wipTrend+'</div><div class="metric-label">–¢—Ä–µ–Ω–¥ WIP</div></div>'
    +'<div class="metric-card"><div class="metric-val v-orange">'+m.thCV+'</div><div class="metric-label">CV Throughput</div></div>'
    +'</div>'
    +'<div style="margin-bottom:16px;"><div style="font-family:Russo One;font-size:.7rem;text-transform:uppercase;letter-spacing:1.5px;color:var(--text-secondary);margin-bottom:8px;">–û–±–Ω–∞—Ä—É–∂–µ–Ω–Ω—ã–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã</div>'+patternTags+'</div>'
    +'<button class="btn btn-primary" onclick="nextStep()" style="width:100%;justify-content:center;">üìã –ü–µ—Ä–µ–π—Ç–∏ –∫ –æ—Ç—á—ë—Ç—É</button>'
    +'</div></div>';

  setTimeout(function(){
    var c = document.getElementById('metricsChart');
    if(c && G.data) {
      var anns = [];
      anns.push({type:'hline', val:m.avgWip, color:'#39c5cf', label:'Avg WIP: '+m.avgWip});
      renderCFD(c, G.data, {annotations:anns, height:280});
    }
  }, 50);
}

// ---- REPORT STEP ----
function renderReportStep() {
  var m = G.metrics;
  var patterns = detectPatterns(G.data, m);

  var sections = '';

  var health = m.isDiverging ? 'bad' : m.avgWip > 15 || m.maxStall >= 3 ? 'warn' : 'good';
  var healthTitle = health==='good'?'–°–∏—Å—Ç–µ–º–∞ –≤ —Ö–æ—Ä–æ—à–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–∏':health==='warn'?'–ï—Å—Ç—å –∑–æ–Ω—ã –¥–ª—è —É–ª—É—á—à–µ–Ω–∏—è':'–¢—Ä–µ–±—É–µ—Ç—Å—è –≤–º–µ—à–∞—Ç–µ–ª—å—Å—Ç–≤–æ';
  var healthText = health==='good'
    ? '–í–∞—à –ø–æ—Ç–æ–∫ —Å—Ç–∞–±–∏–ª–µ–Ω. WIP –∫–æ–Ω—Ç—Ä–æ–ª–∏—Ä—É–µ–º, Throughput –ø—Ä–µ–¥—Å–∫–∞–∑—É–µ–º. –§–æ–∫—É—Å ‚Äî –Ω–∞ –ø–æ–¥–¥–µ—Ä–∂–∞–Ω–∏–∏ –±–∞–ª–∞–Ω—Å–∞ –∏ –ø–æ—Å—Ç–µ–ø–µ–Ω–Ω–æ–π –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏.'
    : health==='warn'
      ? '–ï—Å—Ç—å –ø—Ä–∏–∑–Ω–∞–∫–∏ –Ω–µ—Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏: '+(m.avgWip>15?'–≤—ã—Å–æ–∫–∏–π WIP ('+m.avgWip+'), ':'')+(m.maxStall>=3?'—Å—Ç–∞–≥–Ω–∞—Ü–∏—è Done ('+m.maxStall+' –¥–Ω.), ':'')+'–≤–∞—Ä–∏–∞–±–µ–ª—å–Ω–æ—Å—Ç—å CV='+m.thCV+'. –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –≤–≤–µ—Å—Ç–∏ WIP-–ª–∏–º–∏—Ç—ã.'
      : '–°–∏—Å—Ç–µ–º–∞ –Ω–µ—Å—Ç–∞–±–∏–ª—å–Ω–∞: WIP —Ä–∞—Å—Ç—ë—Ç (—Ç—Ä–µ–Ω–¥: +'+m.wipTrend+'), –ª–∏–Ω–∏–∏ —Ä–∞—Å—Ö–æ–¥—è—Ç—Å—è. –ë–µ–∑ –≤–º–µ—à–∞—Ç–µ–ª—å—Å—Ç–≤–∞ Lead Time –ø—Ä–æ–¥–æ–ª–∂–∏—Ç —Ä–∞—Å—Ç–∏. –ù—É–∂–Ω—ã —Å—Ä–æ—á–Ω—ã–µ WIP-–ª–∏–º–∏—Ç—ã.';
  sections += '<div class="report-section r-'+health+'"><div class="r-title">–û–±—â–∞—è –æ—Ü–µ–Ω–∫–∞</div><div class="r-text">'+healthText+'</div></div>';

  sections += '<div class="report-section r-info"><div class="r-title">–ó–∞–∫–æ–Ω –õ–∏—Ç—Ç–ª–∞</div><div class="r-text"><strong>WIP = '+m.avgWip+'</strong> | <strong>Throughput = '+m.avgTh+'/–¥–µ–Ω—å</strong> | <strong>Lead Time = '+m.avgLT+' –¥–Ω–µ–π</strong><br>–§–æ—Ä–º—É–ª–∞: LT = WIP / TH = '+m.avgWip+' / '+m.avgTh+' = '+m.avgLT+' –¥–Ω–µ–π.<br>'
    +(m.avgLT > 10 ? 'Lead Time –≤—ã—Å–æ–∫–∏–π. –°–Ω–∏–∂–µ–Ω–∏–µ WIP –¥–æ '+ Math.max(3,Math.round(m.avgWip*0.5))+' –¥–∞—Å—Ç Lead Time ~'+Math.round(Math.max(3,Math.round(m.avgWip*0.5))/m.avgTh*10)/10+' –¥–Ω–µ–π.'
      : 'Lead Time –≤ –ø—Ä–∏–µ–º–ª–µ–º—ã—Ö –ø—Ä–µ–¥–µ–ª–∞—Ö.')
    +'</div></div>';

  var pHtml = patterns.map(function(p){
    var cls = p.severity==='good'?'r-good':p.severity==='warn'?'r-warn':'r-bad';
    return '<div class="report-section '+cls+'"><div class="r-title">'+p.name+'</div><div class="r-text">'+p.desc+'</div></div>';
  }).join('');
  sections += pHtml;

  var fcDays = m.forecastDays;
  var fcText = fcDays === Infinity ? '–ù–µ–≤–æ–∑–º–æ–∂–Ω–æ (Throughput = 0)' : fcDays + ' –¥–Ω–µ–π';
  var recWip = Math.max(3, Math.round(m.avgWip * 0.6));
  var recLT = m.avgTh > 0 ? Math.round(recWip / m.avgTh * 10)/10 : '-';
  sections += '<div class="report-section r-info"><div class="r-title">–ü—Ä–æ–≥–Ω–æ–∑</div><div class="r-text">'
    +'<div class="forecast-box">'
    +'<div class="forecast-row"><span class="f-label">–û—Å—Ç–∞–≤—à–∏–µ—Å—è –∑–∞–¥–∞—á–∏</span><span class="f-val">'+m.remaining+'</span></div>'
    +'<div class="forecast-row"><span class="f-label">–°—Ä–µ–¥–Ω–∏–π Throughput</span><span class="f-val">'+m.avgTh+' / –¥–µ–Ω—å</span></div>'
    +'<div class="forecast-row"><span class="f-label">–ü—Ä–æ–≥–Ω–æ–∑ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è</span><span class="f-val">'+fcText+'</span></div>'
    +'<div class="forecast-row"><span class="f-label">–†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–π WIP-–ª–∏–º–∏—Ç</span><span class="f-val">'+recWip+'</span></div>'
    +'<div class="forecast-row"><span class="f-label">–¶–µ–ª–µ–≤–æ–π Lead Time (–ø—Ä–∏ WIP '+recWip+')</span><span class="f-val">'+recLT+' –¥–Ω–µ–π</span></div>'
    +'</div>'
    +'</div></div>';

  var recs = [];
  if (m.isDiverging || m.avgWip > 10) recs.push('–í–≤–µ–¥–∏—Ç–µ WIP-–ª–∏–º–∏—Ç = '+recWip+'. –≠—Ç–æ —Å–Ω–∏–∑–∏—Ç Lead Time –¥–æ ~'+recLT+' –¥–Ω–µ–π.');
  if (m.maxStall >= 3) recs.push('–£—Å—Ç—Ä–∞–Ω–∏—Ç–µ –±–ª–æ–∫–µ—Ä—ã –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è. '+m.maxStall+' –¥–Ω–µ–π —Å—Ç–∞–≥–Ω–∞—Ü–∏–∏ Done ‚Äî –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π —Å–∏–≥–Ω–∞–ª.');
  if (m.thCV > 1.0) recs.push('–°—Ç–∞–±–∏–ª–∏–∑–∏—Ä—É–π—Ç–µ Throughput: —É–º–µ–Ω—å—à–∏—Ç–µ —Ä–∞–∑–º–µ—Ä –∑–∞–¥–∞—á, —É–±–µ—Ä–∏—Ç–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏.');
  if (m.avgArrival > m.avgTh * 1.3) recs.push('–£–ø—Ä–∞–≤–ª—è–π—Ç–µ –≤—Ö–æ–¥—è—â–∏–º –ø–æ—Ç–æ–∫–æ–º: Arrival Rate ('+m.avgArrival+') –∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω–æ –≤—ã—à–µ Throughput ('+m.avgTh+').');
  if (recs.length === 0) recs.push('–ü—Ä–æ–¥–æ–ª–∂–∞–π—Ç–µ –≤ —Ç–æ–º –∂–µ –¥—É—Ö–µ. –§–æ–∫—É—Å ‚Äî –Ω–∞ –ø—Ä–µ–¥—Å–∫–∞–∑—É–µ–º–æ—Å—Ç–∏ –∏ –ø–æ—Å—Ç–æ—è–Ω–Ω–æ–º —É–ª—É—á—à–µ–Ω–∏–∏.');
  sections += '<div class="report-section r-'+(health==='good'?'good':'warn')+'"><div class="r-title">–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏</div><div class="r-text"><ul style="padding-left:18px;">'+recs.map(function(r){return '<li style="margin-bottom:6px;">'+r+'</li>';}).join('')+'</ul></div></div>';

  var area = document.getElementById('mainArea');
  area.innerHTML = '<div class="content-card"><div class="cc-header"><span class="cc-type type-report">–û—Ç—á—ë—Ç</span><div><div class="cc-title">–ê–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∏–π –æ—Ç—á—ë—Ç –ø–æ –≤–∞—à–µ–π CFD</div><div class="cc-desc">21 –¥–µ–Ω—å, '+m.totalDone+' –∑–∞–≤–µ—Ä—à—ë–Ω–Ω—ã—Ö –∑–∞–¥–∞—á</div></div></div>'
    +'<div class="cc-body">'
    +'<div class="chart-container"><canvas id="reportChart"></canvas>'
    +'<div class="chart-legend"><div class="leg"><div class="leg-dot" style="background:var(--todo-color);"></div>ToDo</div><div class="leg"><div class="leg-dot" style="background:var(--wip-color);"></div>In Progress</div><div class="leg"><div class="leg-dot" style="background:var(--done-color);"></div>Done</div></div></div>'
    + sections
    +'<button class="btn btn-accent" onclick="nextStep()" style="width:100%;margin-top:8px;justify-content:center;">üèÅ –ó–∞–≤–µ—Ä—à–∏—Ç—å</button>'
    +'</div></div>';

  setTimeout(function(){
    var c = document.getElementById('reportChart');
    if(c && G.data) {
      var anns = [
        {type:'hline', val:m.avgWip, color:'#39c5cf', label:'Avg WIP'},
        {type:'hline', val:recWip, color:'#238636', label:'WIP Limit: '+recWip}
      ];
      renderCFD(c, G.data, {annotations:anns, height:300});
    }
  }, 50);
}

// ---- NAVIGATION ----
function nextStep() {
  G.step++;
  showStep();
}

// ---- FINISH ----
function finishGame() {
  document.getElementById('gameWrap').classList.remove('active');
  var total = G.best + G.ok + G.bad;
  var bestPct = total > 0 ? Math.round((G.best/total)*100) : 0;
  var title, rank, gc, gradeText;

  if (G.score >= 50 && bestPct >= 60) {
    title = 'CFD-–ú–∞—Å—Ç–µ—Ä'; rank = '–ì—Ä–µ–π–¥ S ‚Äî –≠–∫—Å–ø–µ—Ä—Ç–Ω—ã–π —É—Ä–æ–≤–µ–Ω—å'; gc='g-s';
    gradeText = '–í—ã –æ—Ç–ª–∏—á–Ω–æ –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç–µ CFD, –≤–µ—Ä–Ω–æ —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç–µ –º–µ—Ç—Ä–∏–∫–∏ –∏ –¥–∞—ë—Ç–µ –æ–±–æ—Å–Ω–æ–≤–∞–Ω–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏. –í–∞—à –∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∏–π –æ—Ç—á—ë—Ç ‚Äî –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–æ–≥–æ –∫–∞—á–µ—Å—Ç–≤–∞.';
  } else if (G.score >= 35) {
    title = 'CFD-–ê–Ω–∞–ª–∏—Ç–∏–∫'; rank = '–ì—Ä–µ–π–¥ A ‚Äî –ü—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–π'; gc='g-a';
    gradeText = '–•–æ—Ä–æ—à–∏–π —É—Ä–æ–≤–µ–Ω—å –∞–Ω–∞–ª–∏–∑–∞ CFD. –ù–µ–∫–æ—Ç–æ—Ä—ã–µ –Ω—é–∞–Ω—Å—ã –µ—â—ë —Ç—Ä–µ–±—É—é—Ç –ø—Ä–æ—Ä–∞–±–æ—Ç–∫–∏, –Ω–æ —Ñ—É–Ω–¥–∞–º–µ–Ω—Ç –∫—Ä–µ–ø–∫–∏–π.';
  } else if (G.score >= 18) {
    title = 'CFD-–ù–∞–±–ª—é–¥–∞—Ç–µ–ª—å'; rank = '–ì—Ä–µ–π–¥ B ‚Äî –°—Ä–µ–¥–Ω–∏–π'; gc='g-b';
    gradeText = '–ë–∞–∑–æ–≤–æ–µ –ø–æ–Ω–∏–º–∞–Ω–∏–µ CFD –µ—Å—Ç—å, –Ω–æ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –∏ —Ä–∞—Å—á—ë—Ç—ã —Ç—Ä–µ–±—É—é—Ç –¥–æ—Ä–∞–±–æ—Ç–∫–∏. –ü–µ—Ä–µ—Å–º–æ—Ç—Ä–∏—Ç–µ –∑–∞–∫–æ–Ω –õ–∏—Ç—Ç–ª–∞ –∏ –ø–∞—Ç—Ç–µ—Ä–Ω—ã.';
  } else {
    title = 'CFD-–ù–æ–≤–∏—á–æ–∫'; rank = '–ì—Ä–µ–π–¥ C ‚Äî –ù–∞—á–∞–ª—å–Ω—ã–π'; gc='g-c';
    gradeText = '–ê–Ω–∞–ª–∏–∑ CFD –ø–æ–∫–∞ –¥–∞—ë—Ç—Å—è —Å —Ç—Ä—É–¥–æ–º. –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º –ø–æ–≤—Ç–æ—Ä–∏—Ç—å —Ç–µ–æ—Ä–∏—é: —Ç—Ä–∏ –º–µ—Ç—Ä–∏–∫–∏, –∑–∞–∫–æ–Ω –õ–∏—Ç—Ç–ª–∞, –æ—Å–Ω–æ–≤–Ω—ã–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã.';
  }

  document.getElementById('fTitle').textContent = title;
  document.getElementById('fScore').textContent = G.score + ' pts';
  document.getElementById('fRank').textContent = rank;
  document.getElementById('fStats').innerHTML =
    '<div class="f-stat"><span>–í–æ–ø—Ä–æ—Å–æ–≤</span><span class="fv">'+total+'</span></div>'
    +'<div class="f-stat"><span>–í–µ—Ä–Ω—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤</span><span class="fv">'+G.best+'</span></div>'
    +'<div class="f-stat"><span>–ö–æ–º–ø—Ä–æ–º–∏—Å—Å–æ–≤</span><span class="fv">'+G.ok+'</span></div>'
    +'<div class="f-stat"><span>–û—à–∏–±–æ–∫</span><span class="fv">'+G.bad+'</span></div>'
    +'<div class="f-stat"><span>–¢–æ—á–Ω–æ—Å—Ç—å</span><span class="fv">'+bestPct+'%</span></div>';
  document.getElementById('fGrade').className = 'f-grade '+gc;
  document.getElementById('fGrade').textContent = gradeText;
  document.getElementById('finishScreen').classList.remove('hidden');
}

// ---- START ----
function startGame() {
  STEPS = buildSteps();
  quizCounter = 0;
  document.getElementById('introScreen').classList.add('hidden');
  document.getElementById('gameWrap').classList.add('active');
  renderProgress();
  showStep();
}

// ---- INIT ----
renderDatasetCards();
</script>
</body>
</html>
